<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>H√†nh tr√¨nh an to√†n m·∫°ng</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap');
body { margin:0; font-family:'Poppins', sans-serif; overflow:hidden; background: linear-gradient(#6bd5ff, #b9f1ff); }
/* S·ª≠a l·ªói n·ªÅn xanh c·ªßa quiz */
#quiz {
    display: none;
    flex-direction: column;
    justify-content: center; 
    align-items: center;
    height: 100vh;
    width: 100vw;
    background: linear-gradient(#6bd5ff, #b9f1ff); 
}
/* Thu nh·ªè poster ƒë·ªÉ kh√¥ng b·ªã qu√° to */
#poster img {
    max-width: 90%;
    max-height: 80vh;
    object-fit: contain;
}

/* INTRO */
#introContainer,#outroScreen { width:100vw; height:100vh; display:flex; flex-direction:column; justify-content:center; align-items:center; text-align:center; padding:20px; box-sizing:border-box; }
#outroScreen { display:none; flex-direction:column; justify-content:center; align-items:center; text-align:center; animation: bgFade 5s ease-in-out infinite; }

#introText { max-width:800px; color:#004760; font-size:20px; line-height:1.6; }

/* Name input */
#nameBox { display:none; margin-top:20px; text-align:center; }
#playerName { padding:10px; font-size:18px; border-radius:10px; border:2px solid #5ab4ff; }

/* H∆∞·ªõng d·∫´n tr√™n th√°p */
#towerGuide { text-align:center; font-size:20px; color:#004b70; margin-top:20px; display:none; }

/* GAME */
#gameTitle { display:none; text-align:center; margin-top:20px; color:#0077c8; }
.game-area { display:none; flex-direction:row; justify-content:center; align-items:flex-end; gap: 40px; margin-top: 60px; position:relative; height:400px; }
.tower { width:120px; height:150px; border-radius:20px 20px 0 0; display:flex; flex-direction:column; align-items:center; justify-content:flex-end; cursor:pointer; position:relative; box-shadow:0 8px 20px rgba(0,0,0,0.25); transition:0.3s; }
.tower:hover { transform: scale(1.05); }
.roof { width:120px; height:40px; clip-path: polygon(50% 0%, 100% 100%, 0% 100%); margin-bottom:0; box-shadow:0 4px 10px rgba(0,0,0,0.3); }

#tower1 { background:#ffe5b4; } #tower1 .roof { background:#ff7f50; }
#tower2 { background:#d0f0c0; } #tower2 .roof { background:#32cd32; }
#tower3 { background:#c0d6f0; } #tower3 .roof { background:#1e90ff; }
#tower4 { background:#f4c2c2; } #tower4 .roof { background:#ff4500; }

.character { width:50px; height:50px; background:#ffeb3b; border-radius:50%; position:absolute; display:flex; align-items:center; justify-content:center; font-size:24px; z-index:5; transition:0.3s; }

/* POPUP */
.popup { position:fixed; top:50%; left:50%; transform:translate(-50%,-50%); background:white; padding:20px; border-radius:15px; box-shadow:0 8px 25px rgba(0,0,0,0.35); display:none; z-index:10; width:350px; max-width:90vw; }
.popup h2 { margin-top:0; color:#0077c8; }
.popup button { width:100%; padding:12px; background:#00a8ff; color:white; border:none; border-radius:8px; font-weight:bold; cursor:pointer; margin-top:5px; }
.popup button:hover { background:#0077c8; }

.tower.level1 { box-shadow:0 0 10px 3px gold; height:200px; }
.tower.level2 { box-shadow:0 0 15px 5px orange; height:250px; }
.tower.level3 { box-shadow:0 0 25px 8px red; height:300px; }

/* small styles for video/quiz popups */
#congratsPopup .line { margin:8px 0; color:#073b4c; }
#videoPopup video { width:100%; height:auto; border-radius:8px; background:#000; }
.quiz-answers { margin-top:12px; display:flex; flex-direction:column; gap:8px; }
.quiz-answers button, .quiz-answers .submit-btn { width:100%; padding:10px; border-radius:8px; border:none; cursor:pointer; font-weight:600; }
.checkbox-row { display:flex; flex-direction:column; gap:6px; margin-top:8px; text-align:left; }

/* Gradient animation outro */
@keyframes bgFade {
  0% { background: linear-gradient(#6bd5ff, #b9f1ff); }
  50% { background: linear-gradient(#b9f1ff, #6bd5ff); }
  100% { background: linear-gradient(#6bd5ff, #b9f1ff); }
}
</style>

<style>
#leaderboard table {
  border-collapse: collapse;
  width: 80%;
  margin: 20px auto;
  background: white;
  border-radius: 12px;
  overflow: hidden;
}
#leaderboard th {
  background: #4aa3ff;
  color: white;
  padding: 12px;
  font-size: 18px;
}
#leaderboard td {
  padding: 10px;
  text-align: center;
  font-size: 16px;
}
#leaderboard tr:nth-child(even) { background: #f2f7ff; }
.medal { font-size:22px; }
</style>


<style>
#top50Btn {
 position: fixed;
 top: 10px;
 right: 10px;
 padding: 6px 10px;
 background:#007bff;
 color:white;
 border:none;
 border-radius:8px;
 font-size:14px;
 display:none;
 z-index:9999;
}
</style>


<!-- Firebase CDN -->
<script src="https://www.gstatic.com/firebasejs/10.14.0/firebase-app.js">
function computeScore(){
    const totalQuestions = 22;
    const base = totalQuestions * 100;
    const timePenalty = Math.floor((Date.now() - window.startTime)/1000);
    const wrongPenalty = window.wrongCount * 100;
    let score = base - timePenalty - wrongPenalty;
    if(score<0) score=0;
    return {score, timePenalty};
}

</script>
<script src="https://www.gstatic.com/firebasejs/10.14.0/firebase-firestore.js">
function computeScore(){
    const totalQuestions = 22;
    const base = totalQuestions * 100;
    const timePenalty = Math.floor((Date.now() - window.startTime)/1000);
    const wrongPenalty = window.wrongCount * 100;
    let score = base - timePenalty - wrongPenalty;
    if(score<0) score=0;
    return {score, timePenalty};
}

</script>

<script>
window.correctCount=0; window.wrongCount=0; window.startTime=Date.now();
  const firebaseConfig = {
    apiKey: "AIzaSyBp-d-t6eQ0GuXTehgoPD-h99xB1YUg2Lc",
    authDomain: "an-toan-internet.firebaseapp.com",
    projectId: "an-toan-internet",
    storageBucket: "an-toan-internet.firebasestorage.app",
    messagingSenderId: "32947390990",
    appId: "1:32947390990:web:71ec5d85e6b0cef78d4a5f",
    measurementId: "G-X7HLNTRBZG"
  };
  const app = firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

function computeScore(){
    const totalQuestions = 22;
    const base = totalQuestions * 100;
    const timePenalty = Math.floor((Date.now() - window.startTime)/1000);
    const wrongPenalty = window.wrongCount * 100;
    let score = base - timePenalty - wrongPenalty;
    if(score<0) score=0;
    return {score, timePenalty};
}

</script>

</head>
<body>
<button id='top50Btn' onclick='showTop50()'>TOP 50</button>
<!-- QR GAME -->
<div style="position:fixed; top:1px; right:1px; z-index:9999;">
  <img src="qr_game_link.png" style="width:60px; height:auto; border-radius:8px;">
</div>


<!-- === NH·∫†C N·ªÄN === -->
<audio id="bgMusic" loop>
  <source src="music.mp3" type="audio/mpeg">
</audio>

<!-- === √ÇM THANH ƒê√öNG ‚Äì SAI === -->
<audio id="correctSound">
  <source src="correct.mp3" type="audio/mpeg">
</audio>

<audio id="wrongSound">
  <source src="wrong.mp3" type="audio/mpeg">
</audio>

<!-- INTRO -->
<div id="introContainer">
  <div id="introText"></div>
  
<div id="nameBox" style="display:none; margin-top:20px; text-align:center;">
  <label>Th√¥ng tin ng∆∞·ªùi ch∆°i:</label><br><br>
  <input id="playerName" type="text" placeholder="H·ªç v√† t√™n" style="padding:10px;border-radius:10px;margin:5px;"><br>
  <input id="playerClass" type="text" placeholder="L·ªõp" style="padding:10px;border-radius:10px;margin:5px;"><br>
  <input id="playerSchool" type="text" placeholder="Tr∆∞·ªùng" style="padding:10px;border-radius:10px;margin:5px;"><br>
  <button onclick="startGame()" style="padding:10px 20px;border-radius:10px;">B·∫Øt ƒë·∫ßu</button>
</div>

</div>

<!-- N√öT HI·ªÇN TH·ªä H∆Ø·ªöNG D·∫™N -->
<div style="text-align:center; margin-top:10px;">
  <button id="towerGuideBtn" style="padding:10px 16px; background:#00a8ff; color:#fff; border:none; border-radius:8px; cursor:pointer; font-weight:600;" onclick="loadMyRank()">H∆∞·ªõng d·∫´n Th√°p</button>
</div>

<!-- POPUP H∆Ø·ªöNG D·∫™N -->
<div id="towerGuidePopup" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.6); z-index:50; justify-content:center; align-items:center; padding:20px; display:flex;">
  <div style="background:#fff; max-width:700px; width:100%; border-radius:12px; padding:20px; box-shadow:0 12px 35px rgba(0,0,0,0.35); overflow:auto; max-height:80vh;">
    <h2 style="margin-top:0; color:#0077c8;">H∆∞·ªõng d·∫´n s·ª≠ d·ª•ng ‚Äî 4 t√≤a th√°p</h2>
    <p><strong>M·ª•c ti√™u:</strong> Tr·∫£ l·ªùi ƒë√∫ng c√°c c√¢u h·ªèi ƒë·ªÉ n√¢ng c·∫•p 4 t√≤a th√°p l√™n m·ª©c t·ªëi ƒëa.</p>
    <ol style="text-align:left; padding-left:18px;">
      <li><strong>Nh·∫≠p t√™n:</strong> Nh·∫≠p t√™n r·ªìi nh·∫•n <em>B·∫Øt ƒë·∫ßu</em>.</li>
      <li><strong>Ch·ªçn t√≤a th√°p:</strong> Nh·∫•p v√†o t√≤a th√°p b·∫°n mu·ªën tr·∫£ l·ªùi.</li>
      <li><strong>Tr·∫£ l·ªùi 1 c√¢u:</strong> M·ªói th√°p ch·ªâ c√≥ 1 c√¢u h·ªèi, ch·ªçn 1 trong 3 ƒë√°p √°n.</li>
      <li><strong>N√¢ng c·∫•p :</strong> N·∫øu ƒë√∫ng, th√°p s·∫Ω ƒë·∫°t m·ª©c t·ªëi ƒëa ngay.</li>
      <li><strong>Th·ª≠ l·∫°i khi sai:</strong> N·∫øu sai, c√≥ th√¥ng b√°o, b·∫°n c√≥ th·ªÉ th·ª≠ l·∫°i.</li>
      <li><strong>Ho√†n th√†nh tr√≤ ch∆°i:</strong> Khi c·∫£ 4 th√°p ƒë·ªÅu ƒë·∫°t m·ª©c t·ªëi ƒëa, m√†n kh√°c s·∫Ω xu·∫•t hi·ªán.</li>
    </ol>
    <p style="font-size:13px; color:#555; margin-top:10px;">B·∫°n c√≥ th·ªÉ l√†m th√°p theo b·∫•t k·ª≥ th·ª© t·ª± n√†o. Tr√≤ ch∆°i s·∫Ω ƒë·∫øm th·ªùi gian b·∫°n ch∆°i khi b·∫°n nh·∫•n b·∫Øt ƒë·∫ßu.</p>
    <div style="text-align:right; margin-top:12px;">
      <button style="padding:10px 16px; background:#ff6b6b; color:#fff; border:none; border-radius:8px; cursor:pointer; font-weight:600;" onclick="closeTowerGuide()">ƒê√≥ng</button>
    </div>
  </div>
</div>

<!-- H∆∞·ªõng d·∫´n tr√™n th√°p -->
<div id="towerGuide" style="display:none;">
  Ch·ªçn v√†o m·ªói t√≤a th√°p ‚Äî m·ªói t√≤a t∆∞·ª£ng tr∆∞ng cho m·ªôt t√†i kho·∫£n c·ªßa Minh. Nh·∫•p v√†o th√°p ƒë·ªÉ ƒë·∫∑t m·∫≠t kh·∫©u m·∫°nh!
</div>

<!-- GAME -->
<h1 id="gameTitle">Mini Game: Ch·ªçn m·∫≠t kh·∫©u m·∫°nh ƒë·ªÉ n√¢ng c·∫•p th√°p</h1>
<div class="game-area" id="gameArea">
  <div class="tower" id="tower1"><div class="roof"></div></div>
  <div class="tower" id="tower2"><div class="roof"></div></div>
  <div class="tower" id="tower3"><div class="roof"></div></div>
  <div class="tower" id="tower4"><div class="roof"></div></div>
  <div class="character" id="character">üòä</div>
</div>

<!-- POPUP -->
<div class="popup" id="popup">
  <h2 id="questionTitle">Ch·ªçn m·∫≠t kh·∫©u</h2>
  <div id="answers"></div>
</div>

<!-- POPUP CU·ªêI TH√ÅP -->
<div class="popup" id="finalPopup">
  <h2>Ch√∫c m·ª´ng!</h2>
  <p>B·∫°n ƒë√£ gi√∫p Minh ƒë·∫∑t m·∫≠t kh·∫©u m·∫°nh, nh∆∞ng ƒë·ªÉ sau n√†y Minh kh√¥ng ƒë·∫∑t m·∫≠t kh·∫©u y·∫øu n·ªØa, b·∫°n n√™n cho Minh 1 s·ªë l·ªùi khuy√™n.</p>
  <button id="nextGameBtn">ƒê∆∞·ª£c th√¥i</button>
</div>

<!-- POPUP L·ªúI KHUY√äN -->
<div class="popup" id="advicePopup">
  <h2 id="adviceQuestion">C√¢u h·ªèi</h2>
  <div id="adviceAnswers"></div>
</div>

<!-- OUTRO -->
<div id="outroScreen">
  <h1 id="outroTitle" style="opacity:0; transition:opacity 1s;">Thank for playing!</h1>
  <p id="outroText" style="opacity:0; transition:opacity 1s;">B·∫°n ƒë√£ ho√†n th√†nh tr√≤ ch∆°i.H√£y chia s·∫ª cho b·∫°n b√® c√πng ch∆°i nh√©.H·∫πn g·∫∑p l·∫°i!Game ƒë∆∞·ª£c t·∫°o b·ªüi H∆∞ng v√† Qu√¢n.</p>
  <div id="outroCharacter" style="width:80px; height:80px; background:#ffeb3b; border-radius:50%; margin-top:30px; display:flex; justify-content:center; align-items:center; font-size:36px; opacity:0; transition:opacity 1s;">üòä</div>
</div>

<!-- ======= NEW: CONGRATS + VIDEO + QUIZ POPUPS (TH√äM M·ªöI, KH√îNG S·ª¨A GAME) ======= -->

<!-- Congratulation popup (shown when showOutro is called) -->
<div class="popup" id="congratsPopup" style="display:none; width:420px;">
  <h2>Ch√∫c m·ª´ng ‚Äî B·∫°n ƒë√£ ho√†n th√†nh tr√≤ ch∆°i!</h2>
  <p class="line">B·∫°n ƒë√£ gi√∫p Minh c·∫£i thi·ªán b·∫£o m·∫≠t. Xem video ng·∫Øn ƒë·ªÉ hi·ªÉu th√™m t√¨nh hu·ªëng l·ª´a ƒë·∫£o.</p>
  <button id="watchVideoBtn">Xem video h∆∞·ªõng d·∫´n</button>
  <button id="skipToQuizBtn" style="background:#ff6b6b; margin-top:8px;">B·ªè qua video ‚Äî Tr·∫£ l·ªùi c√¢u h·ªèi</button>
</div>

<!-- Video popup -->
<div class="popup" id="videoPopup" style="display:none; width:760px; max-width:95vw;">
  <h2>Video minh h·ªça t√¨nh hu·ªëng l·ª´a ƒë·∫£o</h2>
  <video id="lessonVideo" controls>
    <source src="video.mp4" type="video/mp4">
    Tr√¨nh duy·ªát c·ªßa b·∫°n kh√¥ng h·ªó tr·ª£ th·∫ª video.
  </video>
  <button id="skipVideoBtn" style="margin-top:10px; background:#ff6b6b;">B·ªè qua video</button>
</div>

<!-- Quiz popup (4 c√¢u h·ªèi) -->
<div class="popup" id="quizPopup" style="display:none; width:600px; max-width:95vw;">
  <h2 id="quizTitle">B√†i ki·ªÉm tra nhanh</h2>
  <div id="quizBody" style="margin-top:8px; text-align:left;">
    <!-- N·ªôi dung c√¢u h·ªèi s·∫Ω ƒë∆∞·ª£c ch√®n b·∫±ng JS -->
  </div>
  <div style="margin-top:12px;">
    <button id="nextQuizBtn" style="background:#00a8ff;">Ti·∫øp t·ª•c</button>
  </div>
</div>
<div id="activity3Screen" style="display:none; flex-direction:column; justify-content:center; align-items:center; height:100vh; padding:20px; text-align:center; background:#87CEFA;">
  <h1>Ho·∫°t ƒë·ªông 3</h1>
  <p style="font-size:20px; color:#0077c8; margin-bottom:15px;">
    Lan ƒëang l√†m poster tuy√™n truy·ªÅn an to√†n m·∫°ng nh∆∞ng b·∫°n ·∫•y ch·ªâ m·ªõi xong ph·∫ßn tr√¨nh b√†y, b·∫°n h√£y gi√∫p b·∫°n ·∫•y ph·∫ßn n·ªôi dung nh√©.
  </p>
  <button id="startQuizBtn" style="margin-top:20px; padding:10px 16px; background:#00a8ff; color:#fff; border:none; border-radius:8px; cursor:pointer;">OK</button>
</div>

<div id="quiz" style="display:none; flex-direction:column; align-items:center; gap:12px; margin-top:20px;">
  <div id="question" style="font-size:20px; font-weight:600;"></div>
  <div id="options" style="display:flex; flex-direction:column; gap:10px;"></div>
</div>

<div id="poster" style="display:none; margin-top:20px; font-size:18px;">
  <img src="posternh√©.png" alt="Poster" style="max-width:90%; border-radius:12px;">
</div>
<!-- ========================================================================== -->

<script>
// --- INTRO ---
const introLines=["B·∫°n l√† 1 nh√† th√°m hi·ªÉm internet...","Trong l√∫c th√°m hi·ªÉm b·∫°n g·∫∑p Minh ‚Äì 1 ng∆∞·ªùi ƒëang b·ªã nh·ªØng t√™n hacker ƒë√°nh c·∫Øp th√¥ng tin...","Nhi·ªám v·ª• c·ªßa b·∫°n l√† gi√∫p Minh ƒë·∫∑t l·∫°i m·∫≠t kh·∫©u!"];
let lineIndex=0,charIndex=0;
const introText=document.getElementById("introText");
const nameBoxEl=document.getElementById("nameBox");

function typeIntro(){
  introText.innerHTML = ""; 
  lineIndex=0; charIndex=0;

  function typing(){
    if(lineIndex<introLines.length){
      if(charIndex<introLines[lineIndex].length){
        introText.innerHTML+=introLines[lineIndex].charAt(charIndex);
        charIndex++;
        setTimeout(typing,40);
      } else {
        introText.innerHTML+="<br><br>";
        lineIndex++; charIndex=0;
        setTimeout(typing,500);
      }
    } else {
      nameBoxEl.style.display="block";
    }
  }

  typing();
}

// KH√îNG CH·∫†Y INTRO KHI LOAD TRANG N·ªÆA
// window.onload = typeIntro;

// --- NH·∫†C ---
const bgMusic=document.getElementById("bgMusic");
const correctSound=document.getElementById("correctSound");
const wrongSound=document.getElementById("wrongSound");
let bgStart=false;

document.addEventListener("click",()=>{
  if(!bgStart){
    bgMusic.volume=0.5;
    bgMusic.play().catch(()=>{});
    bgStart=true;
  }
});

// --- GAME DATA ---
const towersData = {
  tower1: [{question: "Ch·ªçn m·∫≠t kh·∫©u m·∫°nh.", answers: [{ text: "12345", correct: false },{ text: "Huy3#2025", correct: true },{ text: "abcdef", correct: false }]}],
  tower2: [{question: "Ch·ªçn m·∫≠t kh·∫©u c√≥ s·ªë v√† ch·ªØ vi·∫øt hoa.", answers: [{ text: "Pass1234", correct: true },{ text: "abcdefg", correct: false },{ text: "Password", correct: false }]}],
  tower3: [{question: "Ch·ªçn m·∫≠t kh·∫©u c√≥ ch·ªØ hoa, ch·ªØ th∆∞·ªùng,s·ªë v√† k√Ω t·ª± ƒë·∫∑c bi·ªát.", answers: [{ text: "ABCDEFG", correct: false },{ text: "1234567", correct: false },{ text: "Hoctap@1235", correct: true }]}],
  tower4: [{question: "Ch·ªçn m·∫≠t kh·∫©u ƒë·ªß 8 k√Ω t·ª± tr·ªü l√™n.", answers: [{ text: "12a424a", correct: false },{ text: "SafePassw1", correct: true },{ text: "chamchi@!", correct: false }]}]
};

const towers=document.querySelectorAll('.tower');
const popup=document.getElementById('popup');
const questionTitle=document.getElementById('questionTitle');
const answersDiv=document.getElementById('answers');
const character=document.getElementById('character');
const gameArea=document.getElementById('gameArea');
const gameTitle=document.getElementById('gameTitle');
const towerGuide=document.getElementById('towerGuide');
const finalPopup=document.getElementById('finalPopup');
const advicePopup=document.getElementById('advicePopup');
const adviceQuestionEl=document.getElementById('adviceQuestion');
const adviceAnswersDiv=document.getElementById('adviceAnswers');
const outroScreen=document.getElementById('outroScreen');
const outroChar=document.getElementById('outroCharacter');

let currentTower=null;
let currentLevel={tower1:0,tower2:0,tower3:0,tower4:0};

function startGame(){
  let name = document.getElementById('playerName').value.trim();
  let cls = document.getElementById('playerClass').value.trim();
  let school = document.getElementById('playerSchool').value.trim();
  if(!name || !cls || !school){ alert("Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß t√™n, l·ªõp, tr∆∞·ªùng!"); return;}
  const nameInput=document.getElementById('playerName').value;
  document.getElementById('introContainer').style.display="none";
  towerGuide.style.display="block";
  gameTitle.style.display="block";
  gameArea.style.display="flex";
}

towers.forEach(tower=>{
  tower.addEventListener('click',()=>{
    currentTower=tower.id;
    const rect=tower.getBoundingClientRect();
    const areaRect=gameArea.getBoundingClientRect();
    const x=rect.left-areaRect.left+rect.width/2-character.offsetWidth/2;
    const y=-character.offsetHeight;
    character.style.left=x+'px';
    character.style.top=y+'px';
    showTowerQuestion(currentTower);
  });
});

function showTowerQuestion(towerId){
  const level=currentLevel[towerId];
  if(level>=1){ checkAllTowersCompleted(); return; }
  const q=towersData[towerId][0];
  questionTitle.textContent=q.question;
  answersDiv.innerHTML="";
  q.answers.forEach(ans=>{
    const btn=document.createElement('button');
    btn.textContent=ans.text;
    btn.onclick=()=>checkTowerAnswer(ans.correct);
    answersDiv.appendChild(btn);
  });
  popup.style.display='block';
}

function checkTowerAnswer(isCorrect){
  if(isCorrect){
    correctSound.currentTime=0; correctSound.play();
    alert("Ch·ªçn ƒë√∫ng! Th√°p ƒë∆∞·ª£c n√¢ng c·∫•p üéâ");
    const towerEl=document.getElementById(currentTower);
    currentLevel[currentTower]=3;
    towerEl.classList.add("level3");
  } else { wrongSound.currentTime=0; wrongSound.play(); alert("M·∫≠t kh·∫©u y·∫øu, th·ª≠ l·∫°i üò¢"); }
  popup.style.display='none';
  checkAllTowersCompleted();
}

function checkAllTowersCompleted(){
  const allDone=Object.values(currentLevel).every(l=>l>=1);
  if(allDone){ finalPopup.style.display='block'; }
  
}


document.getElementById('nextGameBtn').onclick=()=>{ finalPopup.style.display='none'; showAdviceGame(); };

// ---- GAME L·ªúI KHUY√äN ----
const adviceQuestions=[
  {q:"Khi ƒë·∫∑t m·∫≠t kh·∫©u, b·∫°n c·∫ßn ___ ƒë·ªÉ b·∫£o m·∫≠t t·ªët h∆°n.",answers:[
    {text:"s·ª≠ d·ª•ng ch·ªØ hoa, ch·ªØ th∆∞·ªùng, s·ªë v√† k√Ω t·ª± ƒë·∫∑c bi·ªát",correct:true},
    {text:"ch·ªâ d√πng s·ªë",correct:false},
    {text:"d√πng t√™n m√¨nh",correct:false}]},
  {q:"M·∫≠t kh·∫©u n√™n c√≥ √≠t nh·∫•t ___ k√Ω t·ª±.",answers:[
    {text:"4 k√Ω t·ª±",correct:false},
    {text:"8 k√Ω t·ª±",correct:true},
    {text:"2 k√Ω t·ª±",correct:false}]},
  {q:"Kh√¥ng n√™n s·ª≠ d·ª•ng ___ trong m·∫≠t kh·∫©u.",answers:[
    {text:"t√™n ng∆∞·ªùi th√¢n ho·∫∑c ng√†y sinh",correct:true},
    {text:"k√Ω t·ª± ƒë·∫∑c bi·ªát",correct:false},
    {text:"ch·ªØ v√† s·ªë",correct:false}]},
  {q:"N√™n thay ƒë·ªïi m·∫≠t kh·∫©u ___ ƒë·ªÉ tr√°nh b·ªã hack.",answers:[
    {text:"kh√¥ng bao gi·ªù",correct:false},
    {text:"th∆∞·ªùng xuy√™n",correct:true},
    {text:"ch·ªâ khi b·ªã qu√™n",correct:false}]},
  {q:"Kh√¥ng n√™n s·ª≠ d·ª•ng ___ gi·ªëng nhau cho nhi·ªÅu t√†i kho·∫£n.",answers:[
    {text:"m·∫≠t kh·∫©u",correct:true},
    {text:"email",correct:false},
    {text:"t√™n ƒëƒÉng nh·∫≠p",correct:false}]}];

let adviceIndex=0;
function showAdviceGame(){ adviceIndex=0; showAdviceQuestion(); }
function showAdviceQuestion(){
  if(adviceIndex>=adviceQuestions.length){ advicePopup.style.display='none'; showOutro(); return; }
  const q=adviceQuestions[adviceIndex];
  adviceQuestionEl.textContent=q.q;
  adviceAnswersDiv.innerHTML="";
  q.answers.forEach(ans=>{
    const btn=document.createElement('button');
    btn.textContent=ans.text;
    btn.onclick=()=>{
      if(ans.correct){ correctSound.currentTime=0; correctSound.play(); alert("Ch·ªçn ƒë√∫ng! üéâ"); adviceIndex++; }
      else{ wrongSound.currentTime=0; wrongSound.play(); alert("Sai, th·ª≠ l·∫°i üò¢"); }
      showAdviceQuestion();
    };
    adviceAnswersDiv.appendChild(btn);
  });
  advicePopup.style.display='block';
  
  }
  function startActivity3(){
  // ·∫®n c√°c m√†n h√¨nh kh√°c
  gameArea.style.display='none';
  quizPopup.style.display='none';
  congratsPopup.style.display='none';
  videoPopup.style.display='none';
  outroScreen.style.display='none';
  
  // Hi·ªÉn th·ªã m√†n h√¨nh Ho·∫°t ƒë·ªông 3
  document.getElementById('activity3Screen').style.display='flex';
  
  // N√∫t ti·∫øp t·ª•c ƒë·ªÉ qua outro
  document.getElementById('activity3NextBtn').onclick = () => {
    document.getElementById('activity3Screen').style.display='none';
    // G·ªçi outro g·ªëc
    if(typeof originalShowOutro === 'function') originalShowOutro();
    else document.getElementById('outroScreen').style.display='flex';
  };
}

// S·ª≠a finishQuizFlow ƒë·ªÉ g·ªçi startActivity3 tr∆∞·ªõc outro
function finishQuizFlow(){
  quizPopup.style.display = 'none';
  congratsPopup.style.display = 'none';
  videoPopup.style.display = 'none';
  
  // G·ªçi Ho·∫°t ƒë·ªông 3 tr∆∞·ªõc outro
  startActivity3();
}

// --- OUTRO ---
function showOutro(){
    window.endTime = Date.now();
    window.totalTime = Math.floor((window.endTime - window.startTime)/1000);
    if(window.correctAnswers!==undefined){ window.playerScore = window.correctAnswers - window.totalTime; }
 document.getElementById("top50Btn").style.display="block";
 const score=computeScore(window.correctAnswers||0, window.totalTime||0); window.playerScore=score;
  // rename button
  document.getElementById("towerGuideBtn").innerText = "B·∫£ng x·∫øp h·∫°ng";

  setTimeout(()=>{ 
    if(document.getElementById('leaderboard')) {
      document.getElementById('leaderboard').style.display='block';
      if(window.loadLeaderboard) loadLeaderboard();
    }
  }, 2500);  // show after outro animation

  advicePopup.style.display='none';
  gameArea.style.display='none';
  gameTitle.style.display='none';
  towerGuide.style.display='none';
  outroScreen.style.display='flex';
  setTimeout(()=>document.getElementById('outroTitle').style.opacity=1,100);
  setTimeout(()=>document.getElementById('outroText').style.opacity=1,1100);
  setTimeout(()=>outroChar.style.opacity=1,2100);
}

// --- H∆Ø·ªöNG D·∫™N TH√ÅP ---
function openTowerGuide(){
  document.getElementById('towerGuidePopup').style.display='flex';
}

function closeTowerGuide(){
  document.getElementById('towerGuidePopup').style.display='none';
  typeIntro();  // << B·∫ÆT ƒê·∫¶U INTRO SAU KHI ·∫§N ƒê√ìNG
}

// Hide poster when story shown
document.getElementById('storyOverlay').addEventListener('transitionstart',()=>{
  try{ document.getElementById('poster').style.display='none'; }catch(e){}
});


function showTop50(){
 document.getElementById("leaderboard").style.display="block";
 if(window.loadLeaderboard) loadLeaderboard();
}

function computeScore(correct, time){
 return correct*100 - time;
}


function computeScore(){
    const totalQuestions = 22;
    const base = totalQuestions * 100;
    const timePenalty = Math.floor((Date.now() - window.startTime)/1000);
    const wrongPenalty = window.wrongCount * 100;
    let score = base - timePenalty - wrongPenalty;
    if(score<0) score=0;
    return {score, timePenalty};
}

</script>

<!-- ======= APPENDED SCRIPT: ch√∫c m·ª´ng ‚Üí video ‚Üí quiz (KH√îNG S·ª¨A GAME) ======= -->
<script>
/*
  L∆ØU √ù: ƒëo·∫°n n√†y ch·ªâ "th√™m" ch·ª©c nƒÉng m·ªõi.
  - Khi h√†m showOutro() ƒë∆∞·ª£c g·ªçi, n√≥ s·∫Ω hi·ªÉn th·ªã popup ch√∫c m·ª´ng (m√¨nh ghi ƒë√® h√†m runtime).
  - Sau khi ho√†n t·∫•t quiz, h√†m showOutro g·ªëc s·∫Ω ƒë∆∞·ª£c g·ªçi ƒë·ªÉ hi·ªÉn th·ªã outro ban ƒë·∫ßu.
*/

// L∆∞u h√†m showOutro g·ªëc
const originalShowOutro = window.showOutro;

// N·∫øu kh√¥ng t·ªìn t·∫°i h√†m g·ªëc (tr∆∞·ªùng h·ª£p), ƒë·∫£m b·∫£o originalShowOutro l√† null
// (trong file g·ªëc, showOutro lu√¥n ƒë∆∞·ª£c ƒë·ªãnh nghƒ©a n√™n originalShowOutro s·∫Ω l√† function)
if (typeof originalShowOutro !== 'function') {
  // kh√¥ng c√≥ h√†m g·ªëc ‚Äî define 1 h√†m m·∫∑c ƒë·ªãnh an to√†n
  window.showOutro = function(){
    document.getElementById('outroScreen').style.display='flex';
  };
} else {
  // GHI ƒê√à showOutro b·∫±ng 1 h√†m m·ªõi, nh∆∞ng s·∫Ω g·ªçi originalShowOutro sau khi quiz xong
  window.showOutro = function(){
    // Hi·ªán popup ch√∫c m·ª´ng (m·ªõi)
    document.getElementById('congratsPopup').style.display = 'block';
  };
}

// DOM elements for new flow
const congratsPopup = document.getElementById('congratsPopup');
const watchVideoBtn = document.getElementById('watchVideoBtn');
const skipToQuizBtn = document.getElementById('skipToQuizBtn');
const videoPopup = document.getElementById('videoPopup');
const lessonVideo = document.getElementById('lessonVideo');
const skipVideoBtn = document.getElementById('skipVideoBtn');
const quizPopup = document.getElementById('quizPopup');
const quizBody = document.getElementById('quizBody');
const nextQuizBtn = document.getElementById('nextQuizBtn');

// ƒê·ªãnh nghƒ©a n·ªôi dung 4 c√¢u h·ªèi theo y√™u c·∫ßu (m·ªôt s·ªë c√¢u cho ph√©p nhi·ªÅu ƒë√°p √°n)
const finalQuiz = [
  {
    id: 1,
    type: 'single', // single-choice
    q: 'C√¢u 1: ƒê√¢u "KH√îNG" ph·∫£i l√† nguy√™n nh√¢n khi·∫øn Minh b·ªã l·ª´a ƒë·∫£o qua m·∫°ng?',
    options: [
      'Tin t∆∞·ªüng v√†o b·∫°n b√®',
      'H·∫•p t·∫•p, thi·∫øu suy nghƒ©',
      'V√¨ nh√† Minh gi√†u'
    ],
    correctIndex: 2 // "V√¨ nh√† Minh gi√†u" l√† ƒë√°p √°n ƒë√∫ng (kh√¥ng ph·∫£i nguy√™n nh√¢n)
  },
  {
    id: 2,
    type: 'multi', // multiple-choice (ch·ªçn t·∫•t c·∫£ th·ªß ƒëo·∫°n ƒë√£ d√πng)
    q: 'C√¢u 2: ƒê·ªëi t∆∞·ª£ng l·ª´a ƒë·∫£o ƒë√£ s·ª≠ d·ª•ng nh·ªØng th·ªß ƒëo·∫°n n√†o ƒë·ªÉ khi·∫øn nh√¢n v·∫≠t tin l√† th·∫≠t? (Ch·ªçn nh·ªØng c√¢u ƒë√∫ng)',
    options: [
      'A. Gi·∫£ m·∫°o t√†i kho·∫£n b·∫°n b√® v√† nh·∫Øn tin v·ªõi gi·ªçng ƒëi·ªáu quen thu·ªôc.',
      'B. Ti·∫øp c·∫≠n n·∫°n nh√¢n l√†m quen v√† d·∫ßn d·∫ßn tr·ªü th√†nh b·∫°n b√® ƒë·ªÉ l·ª´a ƒë·∫£o',
      'C. H·ªëi th√∫c nh√¢n v·∫≠t th·ª±c hi·ªán nhanh ƒë·ªÉ ‚Äúkh√¥ng b·ªè l·ª° c∆° h·ªôi‚Äù.'
    ],
    // Trong t√¨nh hu·ªëng m√¥ t·∫£, c·∫£ A, B, C ƒë·ªÅu l√† th·ªß ƒëo·∫°n ƒë∆∞·ª£c s·ª≠ d·ª•ng ‚Üí n√™n t·∫•t c·∫£ ƒë·ªÅu ƒë√∫ng
    correctIndexes: [0,1,2]
  },
  {
    id: 3,
    type: 'multi',
    q: 'C√¢u 3: Sau khi b·ªã l·ª´a ƒë·∫£o, nh√¢n v·∫≠t ƒë√£ g·∫∑p ph·∫£i h·∫≠u qu·∫£ g√¨? (Ch·ªçn nh·ªØng c√¢u ƒë√∫ng)',
    options: [
      'M·∫•t ti·ªÅn',
      'L·ªô th√¥ng tin c√° nh√¢n, t√†i kho·∫£n m·∫°ng x√£ h·ªôi b·ªã chi·∫øm quy·ªÅn.',
      'B·ªã ƒëe d·ªça, l√†m phi·ªÅn ho·∫∑c ti·∫øp t·ª•c b·ªã nh·∫Øn tin l·ª´a ƒë·∫£o.'
    ],
    // T·∫•t c·∫£ ƒë·ªÅu l√† h·∫≠u qu·∫£ kh·∫£ dƒ© ‚Üí coi c·∫£ 3 l√† ƒë√∫ng
    correctIndexes: [0,1,2]
  },
  {
    id: 4,
    type: 'multi',
    q: 'C√¢u 4: Th√¥ng ƒëi·ªáp c·ªßa ƒëo·∫°n video tr√™n l√† g√¨? (Ch·ªçn t·∫•t c·∫£ c√¢u ƒë√∫ng)',
    options: [
      'Kh√¥ng n√™n tin t∆∞·ªüng tuy·ªát ƒë·ªëi v√†o b·∫•t k·ª≥ ai tr√™n m·∫°ng, k·ªÉ c·∫£ ng∆∞·ªùi quen.',
      'Internet lu√¥n an to√†n n√™n c√≥ th·ªÉ tho·∫£i m√°i chia s·∫ª th√¥ng tin c√° nh√¢n',
      'C·∫£nh gi√°c v·ªõi ƒë∆∞·ªùng link, qu√† t·∫∑ng, ∆∞u ƒë√£i ƒë∆∞·ª£c g·ª≠i ƒë·ªôt ng·ªôt.'
    ],
    // ƒê√°p √°n ƒë√∫ng: 1 v√† 3 (khuy·∫øn c√°o c·∫£nh gi√°c; c√¢u 2 sai)
    correctIndexes: [0,2]
  }
];

let quizIndex = 0;

// H√†m hi·ªÉn th·ªã c√¢u h·ªèi quiz hi·ªán t·∫°i
function renderQuizQuestion(){
  const item = finalQuiz[quizIndex];
  quizBody.innerHTML = '';
  const title = document.createElement('div');
  title.style.fontWeight = '700';
  title.style.marginBottom = '8px';
  title.textContent = item.q;
  quizBody.appendChild(title);

  if(item.type === 'single'){
    const wrap = document.createElement('div');
    wrap.className = 'quiz-answers';
    item.options.forEach((opt, i) => {
      const btn = document.createElement('button');
      btn.textContent = opt;
      btn.onclick = () => {
        // ki·ªÉm tra
        if(i === item.correctIndex){
          correctSound.currentTime = 0; correctSound.play();
          alert('Ch√≠nh x√°c! üéâ');
          quizIndex++;
          if(quizIndex >= finalQuiz.length){
            finishQuizFlow();
          } else {
            renderQuizQuestion();
          }
        } else {
          wrongSound.currentTime = 0; wrongSound.play();
          alert('Sai r·ªìi, th·ª≠ l·∫°i nh√© üò¢');
        }
      };
      wrap.appendChild(btn);
    });
    quizBody.appendChild(wrap);
    // n√∫t next ·∫©n v·ªõi c√¢u single (b·∫•m ƒë√°p √°n s·∫Ω t·ª± chuy·ªÉn)
    nextQuizBtn.style.display = 'none';
  } else if(item.type === 'multi'){
    // hi·ªÉn th·ªã checkbox + n√∫t submit
    const box = document.createElement('div');
    box.className = 'checkbox-row';
    item.options.forEach((opt, i) => {
      const label = document.createElement('label');
      const cb = document.createElement('input');
      cb.type = 'checkbox';
      cb.dataset.idx = i;
      cb.style.marginRight = '8px';
      label.appendChild(cb);
      const span = document.createElement('span');
      span.textContent = opt;
      label.appendChild(span);
      box.appendChild(label);
    });
    quizBody.appendChild(box);

    // show submit button
    nextQuizBtn.style.display = 'inline-block';
    nextQuizBtn.textContent = 'N·ªôp ƒë√°p √°n';
    // ƒë·∫£m b·∫£o listener kh√¥ng b·ªã ƒëƒÉng k√Ω nhi·ªÅu l·∫ßn
    nextQuizBtn.onclick = () => {
      const checked = Array.from(box.querySelectorAll('input[type="checkbox"]:checked')).map(n=>parseInt(n.dataset.idx));
      // sort for comparison
      checked.sort((a,b)=>a-b);
      const correct = item.correctIndexes.slice().sort((a,b)=>a-b);
      // compare arrays
      if(checked.length === correct.length && checked.every((v,i)=>v === correct[i])){
        correctSound.currentTime = 0; correctSound.play();
        alert('Ch√≠nh x√°c! üéâ');
        quizIndex++;
        if(quizIndex >= finalQuiz.length){
          finishQuizFlow();
        } else {
          renderQuizQuestion();
        }
      } else {
        wrongSound.currentTime = 0; wrongSound.play();
        alert('Ch∆∞a ch√≠nh x√°c. H√£y ki·ªÉm tra l·∫°i v√† th·ª≠ l·∫°i nh√© üò¢');
      }
    };
  }
}

// Ho√†n t·∫•t quiz ‚Üí g·ªçi outro g·ªëc ƒë·ªÉ hi·ªÉn th·ªã m√†n outro c≈©
function startActivity3(){
  // ·∫®n c√°c m√†n h√¨nh kh√°c
  gameArea.style.display='none';
  quizPopup.style.display='none';
  congratsPopup.style.display='none';
  videoPopup.style.display='none';
  outroScreen.style.display='none';
  
  // Hi·ªÉn th·ªã m√†n h√¨nh Ho·∫°t ƒë·ªông 3
  document.getElementById('activity3Screen').style.display='flex';
  
  // N√∫t ti·∫øp t·ª•c ƒë·ªÉ qua outro
  document.getElementById('activity3NextBtn').onclick = () => {
    document.getElementById('activity3Screen').style.display='none';
    // G·ªçi outro g·ªëc
    if(typeof originalShowOutro === 'function') originalShowOutro();
    else document.getElementById('outroScreen').style.display='flex';
  };
}

// S·ª≠a finishQuizFlow ƒë·ªÉ g·ªçi startActivity3 tr∆∞·ªõc outro
function finishQuizFlow(){
  quizPopup.style.display = 'none';
  congratsPopup.style.display = 'none';
  videoPopup.style.display = 'none';
  
  // G·ªçi Ho·∫°t ƒë·ªông 3 tr∆∞·ªõc outro
  startActivity3();
}


const quizData = [
  { question: "B·∫°n n√™n l√†m g√¨ ƒë·ªÉ b·∫£o v·ªá m·∫≠t kh·∫©u t√†i kho·∫£n c·ªßa m√¨nh?", options: ["D√πng ng√†y sinh", "T·∫°o m·∫≠t kh·∫©u m·∫°nh v√† kh√¥ng chia s·∫ª", "Vi·∫øt ra gi·∫•y", "D√πng 1 m·∫≠t kh·∫©u cho t·∫•t c·∫£"], answer: 1 },
  { question: "Khi s·ª≠ d·ª•ng n·ªÅn t·∫£ng tr·ª±c tuy·∫øn, b·∫°n n√™n l√†m g√¨ ƒë·ªÉ b·∫£o v·ªá quy·ªÅn ri√™ng t∆∞?", options: ["Kh√¥ng ƒë·ªçc ch√≠nh s√°ch", "Chia s·∫ª th√¥ng tin c√° nh√¢n", "Ki·ªÉm tra ch√≠nh s√°ch v√† ƒëi·ªÅu ch·ªânh c√†i ƒë·∫∑t", "Ch·ªâ ƒëƒÉng th√¥ng tin c√¥ng ty"], answer: 2 },
  { question: "Khi nh·∫≠n ƒë∆∞·ª£c ƒë∆∞·ªùng link l·∫°, b·∫°n n√™n l√†m g√¨?", options: ["Nh·∫•n ngay", "Chia s·∫ª cho b·∫°n b√®", "Kh√¥ng nh·∫•p v√† ki·ªÉm tra ngu·ªìn g·ª≠i", "Sao ch√©p v√†o MXH h·ªèi √Ω ki·∫øn"], answer: 2 },
  { question: "Tr∆∞·ªõc khi ƒëƒÉng b·∫•t c·ª© n·ªôi dung n√†o l√™n m·∫°ng, b·∫°n c·∫ßn ch√∫ √Ω ƒëi·ªÅu g√¨?", options: ["N·ªôi dung h√†i h∆∞·ªõc", "N·ªôi dung an to√†n, ph√π h·ª£p, kh√¥ng g√¢y h·∫°i", "C√≥ nhi·ªÅu l∆∞·ª£t like", "Tr√πng b√†i ng∆∞·ªùi kh√°c"], answer: 1 }
];

let current = 0;

function showQuestion() {
  if(current >= quizData.length){
    document.getElementById("quiz").style.display = "none";
    document.getElementById("poster").style.display = "block"; // hi·ªán poster
    return;
  }

  const q = quizData[current];
  document.getElementById("question").innerText = q.question;
  const optionsDiv = document.getElementById("options");
  optionsDiv.innerHTML = "";

  q.options.forEach((opt, i) => {
    const btn = document.createElement("button");
    btn.innerText = opt;
    btn.style.padding = "10px 16px";
    btn.style.borderRadius = "8px";
    btn.style.border = "none";
    btn.style.cursor = "pointer";
    btn.style.background = "#00a8ff";
    btn.style.color = "#fff";
    btn.style.fontWeight = "600";
    btn.style.margin = "5px";
    btn.onclick = () => checkAnswer(i);
    optionsDiv.appendChild(btn);
  });
}

function checkAnswer(selected){
  if(selected === quizData[current].answer){

    // üîä√Çm thanh ƒë√∫ng
    correctSound.currentTime = 0;
    correctSound.play();

    current++;
    showQuestion();

  } else {

    // üîä√Çm thanh sai
    wrongSound.currentTime = 0;
    wrongSound.play();

    alert("Sai r·ªìi, th·ª≠ l·∫°i nh√©!");
  }
}

// Khi b·∫Øt ƒë·∫ßu ho·∫°t ƒë·ªông 3
function startActivity3(){
  document.getElementById('activity3Screen').style.display='flex';
  current = 0;
  document.getElementById("quiz").style.display = "flex";
  document.getElementById("poster").style.display = "none";
  showQuestion();
}

// B·∫Øt ƒë·∫ßu quiz
showQuestion();

// S·ª± ki·ªán cho n√∫t tr√™n popup ch√∫c m·ª´ng
watchVideoBtn.onclick = () => {
  congratsPopup.style.display = 'none';
  // show video popup
  videoPopup.style.display = 'block';
  // reset video to start
  try { lessonVideo.currentTime = 0; } catch(e){}
  lessonVideo.play().catch(()=>{});
};

skipToQuizBtn.onclick = () => {
  congratsPopup.style.display = 'none';
  // B·∫Øt ƒë·∫ßu quiz tr·ª±c ti·∫øp
  quizIndex = 0;
  quizPopup.style.display = 'block';
  renderQuizQuestion();
};

// S·ª± ki·ªán cho n√∫t b·ªè qua video
skipVideoBtn.onclick = () => {
  try { lessonVideo.pause(); } catch(e){}
  videoPopup.style.display = 'none';
  quizIndex = 0;
  quizPopup.style.display = 'block';
  renderQuizQuestion();
};

// Khi video k·∫øt th√∫c ‚Üí b·∫Øt ƒë·∫ßu quiz
lessonVideo.onended = () => {
  videoPopup.style.display = 'none';
  quizIndex = 0;
  quizPopup.style.display = 'block';
  renderQuizQuestion();
};

// ƒê√≥ng t·∫•t c·∫£ popup khi nh·∫•n ra ngo√†i (tu·ª≥ ch·ªçn) ‚Äî kh√¥ng b·∫Øt bu·ªôc
// (Kh√¥ng g·∫Øn s·ª± ki·ªán ƒë√≥ng khi b·∫•m ngo√†i ƒë·ªÉ tr√°nh v√¥ t√¨nh ƒë√≥ng)

// === T·∫†M D·ª™NG NH·∫†C N·ªÄN KHI XEM VIDEO ===
(function(){
  try {
    const bgMusicEl = document.getElementById('bgMusic');
    const lessonVideoEl = document.getElementById('lessonVideo');
    const skipVideoBtnEl = document.getElementById('skipVideoBtn');

    if(!bgMusicEl || !lessonVideoEl || !skipVideoBtnEl) return;

    // Khi video b·∫Øt ƒë·∫ßu ph√°t ‚Üí t·∫°m d·ª´ng nh·∫°c n·ªÅn
    lessonVideoEl.addEventListener('play', () => {
      try { bgMusicEl.pause(); } catch(e){}
    });

    // Khi video k·∫øt th√∫c ‚Üí ti·∫øp t·ª•c nh·∫°c n·ªÅn
    lessonVideoEl.addEventListener('ended', () => {
      try { bgMusicEl.play().catch(()=>{}); } catch(e){}
    });

    // Khi ng∆∞·ªùi b·∫•m "B·ªè qua video" ‚Üí ti·∫øp t·ª•c nh·∫°c n·ªÅn
    skipVideoBtnEl.addEventListener('click', () => {
      try { bgMusicEl.play().catch(()=>{}); } catch(e){}
    });

  } catch(e){}
})();
function startActivity3() {
    // ·∫®n T·∫§T C·∫¢ c√°c m√†n h√¨nh c≈© tr∆∞·ªõc khi v√†o ho·∫°t ƒë·ªông 3
    gameArea.style.display = 'none';
    gameTitle.style.display = 'none';
    towerGuide.style.display = 'none';
    finalPopup.style.display = 'none';
    popup.style.display = 'none';
    advicePopup.style.display = 'none';
    congratsPopup.style.display = 'none';
    videoPopup.style.display = 'none';
    quizPopup.style.display = 'none';
    outroScreen.style.display = 'none';

    // Hi·ªán m√†n h√¨nh Ho·∫°t ƒë·ªông 3
    document.getElementById('activity3Screen').style.display = 'flex';

    // Reset quiz con
    current = 0;
    document.getElementById("quiz").style.display = "none";
    document.getElementById("poster").style.display = "none";
}

function endActivity3(){
  // ·∫®n Ho·∫°t ƒë·ªông 3
  document.getElementById('activity3Screen').style.display = 'none';
  // Ti·∫øp t·ª•c outro g·ªëc
  showOutro();
}
// G·∫Øn s·ª± ki·ªán cho n√∫t OK
document.getElementById('startQuizBtn').onclick = () => {
    window.startTime = Date.now();
    // ·∫®n m√†n h√¨nh ho·∫°t ƒë·ªông 3
    document.getElementById('activity3Screen').style.display = 'none';
    // B·∫Øt ƒë·∫ßu quiz ho·∫∑c outro ti·∫øp theo
    current = 0;
    document.getElementById("quiz").style.display = "flex";
    document.getElementById("poster").style.display = "none";
    showQuestion(); // g·ªçi h√†m hi·ªÉn th·ªã c√¢u h·ªèi ƒë·∫ßu ti√™n
};

function showTop50(){
 document.getElementById("leaderboard").style.display="block";
 if(window.loadLeaderboard) loadLeaderboard();
}

function computeScore(correct, time){
 return correct*100 - time;
}


function computeScore(){
    const totalQuestions = 22;
    const base = totalQuestions * 100;
    const timePenalty = Math.floor((Date.now() - window.startTime)/1000);
    const wrongPenalty = window.wrongCount * 100;
    let score = base - timePenalty - wrongPenalty;
    if(score<0) score=0;
    return {score, timePenalty};
}

</script>


<!-- BEGIN: Poster congrats + story + super-quiz (added by assistant) -->
<style>
/* Poster congrats popup */
#posterCongratsOverlay, #confirmStoryOverlay, #storyOverlay, #superQuizPopup, #superQuizEnd {
  position: fixed; inset: 0; display: none; z-index: 9999; justify-content:center; align-items:center; background: rgba(0,0,0,0.6);
}
#posterCongrats, #confirmStory, #storyBox, #superQuizBox, #superQuizEndBox {
  background: #fff; border-radius:12px; padding:18px; max-width:900px; width:90%; box-shadow: 0 12px 35px rgba(0,0,0,0.4);
}
#posterCongrats .content { display:flex; gap:16px; align-items:center; }
#posterCongrats .left { flex: 0 0 40%; }
#posterCongrats .left img{ width:100%; height:auto; border-radius:8px; }
#posterCongrats .right { flex:1; text-align:left; }
#posterCongrats h2 { margin-top:0; color:#0077c8; }
.smallBtn { padding:10px 14px; border-radius:8px; border:none; cursor:pointer; font-weight:600; background:#00a8ff; color:#fff; }
.ghostBtn { background:#ff6b6b; }
.storyText { max-height:360px; overflow:auto; text-align:left; line-height:1.5; color:#073b4c; }
#superQuizBox .q { font-weight:700; margin-bottom:10px; }
#superQuizBox .options button { display:block; width:100%; margin:8px 0; padding:10px; border-radius:8px; border:none; cursor:pointer; background:#00a8ff; color:#fff; font-weight:600; }
#superQuizEndBox .animatedText { font-size:20px; line-height:1.6; text-align:center; padding:20px; }
</style>

<!-- Poster congrats overlay -->
<div id="posterCongratsOverlay" aria-hidden="true">
  <div id="posterCongrats" role="dialog">
    <div style="display:flex; justify-content:space-between; align-items:flex-start;">
      <h2>Ch√∫c m·ª´ng ‚Äî B·∫°n ƒë√£ ho√†n th√†nh poster gi√∫p Lan!</h2>
      <button onclick="closePosterCongrats()" style="background:transparent;border:none;font-size:20px;cursor:pointer;">‚úï</button>
    </div>
    <div class="content" style="margin-top:10px;">
      <div class="left"><img src="posternh√©.png" alt="Poster"></div>
      <div class="right">
        <p>B·∫°n ƒë√£ ho√†n th√†nh poster gi√∫p Lan. H√£y nh·∫•n ti·∫øp t·ª•c ƒë·ªÉ nghe m·ªôt c√¢u chuy·ªán d·ª±a tr√™n m·ªôt c√¢u chuy·ªán c√≥ th·∫≠t gi√∫p hi·ªÉu th√™m v·ªÅ c√°ch k·∫ª gian l·ª£i d·ª•ng ch·ªã A.</p>
        <div style="margin-top:12px; display:flex; gap:8px;">
          <button class="smallBtn" id="pcContinueBtn">Ti·∫øp t·ª•c</button>
          <button class="smallBtn ghostBtn" onclick="closePosterCongrats()">ƒê√≥ng</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Confirm to view story -->
<div id="confirmStoryOverlay" aria-hidden="true">
  <div id="confirmStory">
    <h2>B·∫°n c√≥ mu·ªën nghe chuy·ªán c·ªßa ch·ªã A (d·ª±a tr√™n c√¢u chuy·ªán c√≥ th·∫≠t)?</h2>
    <p style="color:#333;">Nghe c√¢u chuy·ªán s·∫Ω gi√∫p b·∫°n hi·ªÉu r√µ c√°ch l·ª´a ƒë·∫£o v·∫≠n h√†nh. B·∫°n c√≥ th·ªÉ <strong>B·ªè qua</strong> v√† tr·∫£ l·ªùi c√¢u h·ªèi ngay.</p>
    <div style="display:flex; gap:10px; margin-top:12px;">
      <button class="smallBtn" id="agreeStoryBtn">ƒê·ªìng √Ω ‚Äî Nghe chuy·ªán</button>
      <button class="smallBtn ghostBtn" id="skipStoryBtn">B·ªè qua ‚Äî Tr·∫£ l·ªùi c√¢u h·ªèi</button>
    </div>
  </div>
</div>

<!-- Story overlay -->
<div id="storyOverlay" aria-hidden="true">
  <div id="storyBox">
    <h2>Chuy·ªán c·ªßa ch·ªã A</h2>
    <div class="storyText" id="storyText">
      <p>Ch·ªã A l√†m vi·ªác trong m·ªôt c·ª≠a h√†ng nh·ªè. M·ªôt bu·ªïi chi·ªÅu, ch·ªã nh·∫≠n ƒë∆∞·ª£c cu·ªôc g·ªçi t·ª´ m·ªôt ng∆∞·ªùi t·ª± x∆∞ng l√† shipper. Anh ta n√≥i r·∫±ng ƒëang gi·ªØ m·ªôt m√≥n h√†ng g·ª≠i cho ch·ªã, nh∆∞ng ch·ªã A b·∫£o r·∫±ng m√¨nh kh√¥ng h·ªÅ ƒë·∫∑t h√†ng.</p>
      <p>B·∫°n ƒë·ªçc ti·∫øp d∆∞·ªõi...</p>
      <p>Ban ƒë·∫ßu, ch·ªã A r·∫•t t·ªânh t√°o v√† tr·∫£ l·ªùi r√µ r√†ng: ‚ÄúT√¥i kh√¥ng ƒë·∫∑t g√¨ c·∫£, anh giao nh·∫ßm r·ªìi.‚Äù Shipper v·∫´n khƒÉng khƒÉng r·∫±ng ƒë√¢y l√† h√†ng ‚Äúƒë·∫∑t tr∆∞·ªõc‚Äù, y√™u c·∫ßu ch·ªã ph·∫£i ra nh·∫≠n ƒë·ªÉ ki·ªÉm tra. Ch·ªã A t·ª´ ch·ªëi th√™m v√†i l·∫ßn nh∆∞ng anh ta li√™n t·ª•c g·ªçi l·∫°i, gi·ªçng ng√†y c√†ng g·∫•p g√°p v√† kh√≥ ch·ªãu.</p>
      <p>M·ªôt l√∫c sau, shipper h·ªèi m·ªôt c√¢u khi·∫øn ch·ªã b·∫Øt ƒë·∫ßu lo l·∫Øng: ‚ÄúCh·ªã c√≥ bi·∫øt trong ki·ªán n√†y c√≥ h√†ng c·∫•m kh√¥ng? Ch·ªã kh√¥ng k√Ω nh·∫≠n l√† ch·ªã ch·ªãu tr√°ch nhi·ªám ƒë√≥.‚Äù Ch·ªã A b·ªëi r·ªëi. Trong ƒë·∫ßu ch·ªã ch·ªâ c√≤n l·∫°i m·ªôt suy nghƒ©: ‚ÄúN·∫øu th·∫≠t l√† h√†ng c·∫•m th√¨ sao? M√¨nh kh√¥ng nh·∫≠n th√¨ c√≥ b·ªã nghi oan kh√¥ng?‚Äù D√π tr∆∞·ªõc ƒë√≥ r·∫•t t·ªânh, ch·ªã b·∫Øt ƒë·∫ßu s·ª£. Anh shipper l·ª£i d·ª•ng c·∫£m gi√°c ·∫•y, li√™n t·ª•c th√∫c √©p: ‚ÄúN·∫øu ch·ªã kh√¥ng mu·ªën b·ªã ph·∫°t, t√¥i s·∫Ω h∆∞·ªõng d·∫´n ch·ªã l√†m th·ªß t·ª•c x√°c minh nhanh. Ch·ªã ch·ªâ c·∫ßn chuy·ªÉn kho·∫£n ph√≠ ki·ªÉm tra ƒë·ªÉ h·ªá th·ªëng ƒë√≥ng x√°c nh·∫≠n.‚Äù</p>
      <p>Ch·ªã A m·ªü t√†i kho·∫£n nh∆∞ng trong th·∫ª kh√¥ng ƒë·ªß ti·ªÅn. L·∫≠p t·ª©c, ng∆∞·ªùi kia ti·∫øp t·ª•c ‚Äúch·ªâ d·∫´n‚Äù: ‚ÄúKh√¥ng sao, ch·ªã vay t·∫°m ng√¢n h√†ng online ƒëi cho nhanh. T√¥i g·ª≠i ch·ªã link n√®, ch·ªâ c·∫ßn b·∫•m v√¥ l√† vay ƒë∆∞·ª£c 25 tri·ªáu. L√£i su·∫•t th·∫•p l·∫Øm, x·ª≠ l√Ω 5 ph√∫t.‚Äù Kh√¥ng k·ªãp suy nghƒ©, ch·ªã A nh·∫•n v√†o ƒë∆∞·ªùng link vay ti·ªÅn. Trang web hi·ªán l√™n r·∫•t gi·ªëng ng√¢n h√†ng th·∫≠t, c√≥ logo, s·ªë h·ª£p ƒë·ªìng, th·∫≠m ch√≠ ch·ªØ k√Ω ƒëi·ªán t·ª≠. V√¨ ƒëang ho·∫£ng lo·∫°n, ch·ªã nh·∫≠p to√†n b·ªô th√¥ng tin c√° nh√¢n, r·ªìi chu·∫©n b·ªã b·∫•m x√°c nh·∫≠n vay.</p>
      <p>ƒê√∫ng l√∫c ƒë√≥, c√¥ ƒë·ªìng nghi·ªáp ƒëi ngang th·∫•y ch·ªã ng·ªìi qu√° l√¢u, m·∫∑t t√°i v√† tay run run n√™n b∆∞·ªõc ƒë·∫øn h·ªèi: ‚ÄúCh·ªã l√†m g√¨ m√† cƒÉng th·∫≥ng v·∫≠y?‚Äù Nghe ch·ªã A k·ªÉ l·∫°i, c√¥ l·∫≠p t·ª©c hi·ªÉu ƒë√≥ l√† l·ª´a ƒë·∫£o chi·∫øm ƒëo·∫°t t√†i s·∫£n. C√¥ gi·∫≠t l·∫°i ƒëi·ªán tho·∫°i, t·∫Øt trang web gi·∫£ v√† y√™u c·∫ßu ch·ªã A kh√¥ng chuy·ªÉn b·∫•t k·ª≥ ƒë·ªìng n√†o, nh∆∞ng ch·ªã A ƒë√£ vay ti·ªÅn tr√™n m·ªôt app ng√¢n h√†ng vay 25 tri·ªáu v·ªõi l√£i su·∫•t si√™u cao. H√™n ch·ªâ m·ªôt click b·∫•m v√†o m√†n h√¨nh n·ªØa th√¥i l√†, ch·ªã A ƒë√£: Chuy·ªÉn ti·ªÅn cho k·∫ª l·ª´a ƒë·∫£o. Nh·ªù c√≥ ng∆∞·ªùi can thi·ªáp k·ªãp th·ªùi, ch·ªã A may m·∫Øn kh√¥ng m·∫•t ti·ªÅn. Nh∆∞ng ch·ªã ph·∫£i g√°nh m√≥n l√£i kh·ªïng l·ªì.</p>
      <p>Sau s·ª± vi·ªác, ch·ªã A n√≥i trong run r·∫©y: ‚ÄúL√∫c ƒë·∫ßu t√¥i t·ªânh t√°o l·∫Øm‚Ä¶ nh∆∞ng h·ªç n√≥i h√†ng c·∫•m l√†m t√¥i s·ª£ qu√°, m·∫•t h·∫øt l√Ω tr√≠.‚Äù</p>
    </div>
    <audio id="storyAudio" controls style="width:100%; margin-top:12px;">
      <source src="voice1.mp3" type="audio/mpeg">
      Tr√¨nh duy·ªát kh√¥ng h·ªó tr·ª£ audio.
    </audio>
    <div style="display:flex; gap:10px; margin-top:12px;">
      <button class="smallBtn" id="storyOkBtn">ƒê√£ nghe xong ‚Äî Qua c√¢u h·ªèi</button>
      <button class="smallBtn ghostBtn" id="storySkipBtn">B·ªè qua ‚Äî Qua c√¢u h·ªèi</button>
    </div>
  </div>
</div>

<!-- Super quiz popup -->
<div id="superQuizPopup" aria-hidden="true">
  <div id="superQuizBox">
    <h2>üß†üî• 5 C√¢u tr·∫Øc nghi·ªám c·∫•p ƒë·ªô SI√äU T·ªêI TH∆Ø·ª¢NG</h2>
    <div id="superQuizContent">
      <!-- question/content injected by JS -->
    </div>
  </div>
</div>

<!-- Super quiz end popup with animated text (will play mp3) -->
<div id="superQuizEnd" aria-hidden="true">
  <div id="superQuizEndBox">
    <h2>K·∫øt th√∫c b√†i ki·ªÉm tra</h2>
    <div class="animatedText" id="animatedText">C·∫£m ∆°n b·∫°n ƒë√£ ho√†n th√†nh! H√£y lu√¥n c·∫£nh gi√°c v√† chia s·∫ª ki·∫øn th·ª©c n√†y v·ªõi ng∆∞·ªùi th√¢n.</div>
    <audio id="endAudio" style="display:none;">
      <source src="voice1.mp3" type="audio/mpeg">
    </audio>
    <div style="display:flex; justify-content:center; margin-top:12px;">
      <button class="smallBtn" onclick="closeSuperQuizEnd()">ƒê√≥ng</button>
    </div>
  </div>
</div>

<script>
// --- Wire up interception of Ho·∫°t ƒë·ªông 3 final question ---
// Keep reference to original checkAnswer if exists
const originalCheckAnswer = window.checkAnswer || null;

// Super-quiz data (using the 4 questions provided in the user's text)
let correctAnswers = 0;
let quizStartTime = Date.now();
const superQuiz = [
  {
    q: "1. Trong chu·ªói di·ªÖn bi·∫øn, ƒë√¢u l√† ƒëi·ªÉm cho th·∫•y k·∫ª l·ª´a ƒë·∫£o kh√¥ng ch·ªâ l·ª£i d·ª•ng n·ªói s·ª£ c·ªßa ch·ªã A, m√† c√≤n t·∫°o ra m·ªôt khu√¥n kh·ªï nh·∫≠n th·ª©c m·ªõi, khi·∫øn ch·ªã A ƒë√°nh gi√° sai b·∫£n ch·∫•t c·ªßa s·ª± vi·ªác?",
    options: ["A. S·ª≠ d·ª•ng t·ª´ kh√≥a 'h√†ng c·∫•m' ƒë·ªÉ t·∫°o s·ª£ h√£i", "B. √âp th·ªùi gian b·∫±ng c√°ch g·ªçi li√™n t·ª•c", "C. Chuy·ªÉn vai t·ª´ shipper ‚Üí ng∆∞·ªùi h·ªó tr·ª£ ph√°p l√Ω m√† kh√¥ng c·∫ßn ch·ª©ng minh", "D. ƒê∆∞a link vay ti·ªÅn v·ªõi giao di·ªán ng√¢n h√†ng th·∫≠t"],
    correct: 2 // index 2 = C
  },
  {
    q: "2. ·ªû g√≥c ƒë·ªô nh·∫≠n th·ª©c sai l·ªách (cognitive distortion), ch·ªã A m·∫Øc ph·∫£i l·ªói n√†o khi·∫øn b·∫£n th√¢n kh√¥ng c√≤n gi·ªØ ƒë∆∞·ª£c ti√™u ch√≠ ki·ªÉm ch·ª©ng th√¥ng tin?",
    options: ["A. Catastrophizing (ph√≥ng ƒë·∫°i h·∫≠u qu·∫£)", "B. Selective attention (ch√∫ √Ω ch·ªçn l·ªçc v·ªÅ ph√≠a r·ªßi ro)", "C. External validation trap (ph·ª• thu·ªôc h∆∞·ªõng d·∫´n b√™n ngo√†i ƒë·ªÉ quy·∫øt ƒë·ªãnh)", "D. Confirmation bias (thi√™n ki·∫øn x√°c nh·∫≠n)"],
    correct: 2 // C
  },
  {
    q: "3. Chi ti·∫øt n√†o cho th·∫•y k·∫ª l·ª´a ƒë·∫£o ƒë√£ c·ªë t√¨nh t·∫°o 'paradox l·ª±a ch·ªçn', khi·∫øn m·ªçi ƒë∆∞·ªùng ch·ªã A ch·ªçn ƒë·ªÅu d·∫´n ƒë·∫øn k·∫øt qu·∫£ c√≥ l·ª£i cho t·ªôi ph·∫°m?",
    options: ["A. 'Kh√¥ng nh·∫≠n h√†ng th√¨ ch·ªã ch·ªãu tr√°ch nhi·ªám.'", "B. 'Ch·ªâ c·∫ßn chuy·ªÉn ph√≠ ƒë·ªÉ x√°c minh.'", "C. 'Kh√¥ng ƒë·ªß ti·ªÅn th√¨ vay ng√¢n h√†ng online ƒëi cho nhanh.'", "D. 'Trang web gi·ªëng h·ªát ng√¢n h√†ng th·∫≠t.'"],
    correct: 0 // A
  },
  {
    q: "4. Ph√¢n t√≠ch theo m√¥ h√¨nh t·∫•n c√¥ng t√¢m l√Ω 't·∫ßng √°p l·ª±c k√©p', c√¢u n√≥i n√†o l√† s·ª± k·∫øt h·ª£p ho√†n h·∫£o nh·∫•t c·ªßa ƒëe d·ªça + gi·∫£i ph√°p, khi·∫øn n·∫°n nh√¢n b·ªã cu·ªën v√†o gu·ªìng?",
    options: ["A. 'Trong ki·ªán c√≥ h√†ng c·∫•m, ch·ªã k√Ω l√† ch·ªãu tr√°ch nhi·ªám.'", "B. 'Kh√¥ng mu·ªën b·ªã ph·∫°t th√¨ t√¥i h∆∞·ªõng d·∫´n th·ªß t·ª•c x√°c minh nhanh.'", "C. 'T√†i kho·∫£n kh√¥ng ƒë·ªß √†? V·∫≠y ch·ªã vay ng√¢n h√†ng online ƒëi cho l·∫π.'", "D. 'Trang n√†y x·ª≠ l√Ω nhanh l·∫Øm, 5 ph√∫t l√† xong.'"],
    correct: 1 // B
  },
  {
    q: "5. Chi ti·∫øt n√†o cho th·∫•y ch·ªã A kh√¥ng c√≤n h√†nh ƒë·ªông d·ª±a tr√™n th√¥ng tin kh√°ch quan m√† d·ª±a tr√™n ‚Äú√°p l·ª±c khung c·∫£nh‚Äù (contextual compulsion)?",
    options: [
      "A. V√†o website gi·∫£ m·∫°o",
      "B. Nh·∫≠p th√¥ng tin c√° nh√¢n",
      "C. Kh√¥ng ƒë·ªçc l√£i su·∫•t nh∆∞ng v·∫´n b·∫•m vay",
      "D. Chu·∫©n b·ªã chuy·ªÉn ti·ªÅn d√π bi·∫øt m√¨nh kh√¥ng ƒë·∫∑t h√†ng"
    ],
    correct: 2 // index 2 = C
  }
];

let superIndex = 0;

function renderSuperQuestion(){
  const box = document.getElementById('superQuizContent');
  box.innerHTML = '';
  if(superIndex >= superQuiz.length){
    // finished
    document.getElementById('superQuizPopup').style.display = 'none';
    showSuperQuizEnd();
    return;
  }
  const item = superQuiz[superIndex];
  const qEl = document.createElement('div');
  qEl.className = 'q';
  qEl.textContent = item.q;
  box.appendChild(qEl);
  const opts = document.createElement('div');
  opts.className = 'options';
  item.options.forEach((opt, i) => {
    const btn = document.createElement('button');
    btn.textContent = opt;
    btn.onclick = () => {
      if(i === item.correct){
        correctAnswers++;

        try { document.getElementById('correctSound').currentTime = 0; document.getElementById('correctSound').play(); } catch(e){}
        alert('Ch√≠nh x√°c!');
        superIndex++;
        renderSuperQuestion();
      } else {
        try { document.getElementById('wrongSound').currentTime = 0; document.getElementById('wrongSound').play(); } catch(e){}
        alert('Sai r·ªìi, th·ª≠ l·∫°i nh√©.');
      }
    };
    opts.appendChild(btn);
  });
  box.appendChild(opts);
}

function showSuperQuiz(){
  superIndex = 0;
  document.getElementById('superQuizPopup').style.display = 'flex';
  renderSuperQuestion();
}

function showSuperQuizEnd(){
    const totalTime = Math.floor((Date.now() - quizStartTime)/1000);
    const score = (correctAnswers * 100) - totalTime;
    alert(`B·∫°n ƒë√∫ng ${correctAnswers} c√¢u trong ${totalTime} gi√¢y.
ƒêi·ªÉm: ${score}`);

  document.getElementById('superQuizEnd').style.display = 'flex';
  // play end audio and animate text (simple fade in)
  const endAudio = document.getElementById('endAudio');
  try { endAudio.currentTime = 0; endAudio.play().catch(()=>{}); } catch(e){}
  const t = document.getElementById('animatedText');
  t.style.opacity = 0;
  setTimeout(()=> t.style.transition = 'opacity 0.8s', 50);
  setTimeout(()=> t.style.opacity = 1, 150);
}

function closeSuperQuizEnd(){
  document.getElementById('superQuizEnd').style.display = 'none';
  // continue with original outro if available
  if(typeof originalShowOutro === 'function') originalShowOutro();
  else document.getElementById('outroScreen').style.display = 'flex';
}

// Show poster congrats overlay (called when user answers Q4 correctly in activity3)
function showPosterCongrats(){
  // hide activity3 quiz
  document.getElementById('quiz').style.display = 'none';
  document.getElementById('poster').style.display = 'block';
  document.getElementById('posterCongratsOverlay').style.display = 'flex';
}

// Close poster congrats
function closePosterCongrats(){
  document.getElementById('posterCongratsOverlay').style.display = 'none';
  // show poster and resume normal flow (poster already displayed)
  document.getElementById('poster').style.display = 'block';
  // Optionally show confirm directly
}

// Hook buttons
document.addEventListener('click', function(e){
  if(e.target && e.target.id === 'pcContinueBtn'){
    document.getElementById('posterCongratsOverlay').style.display = 'none';
    document.getElementById('confirmStoryOverlay').style.display = 'flex';
  }
  if(e.target && e.target.id === 'agreeStoryBtn'){
    document.getElementById('confirmStoryOverlay').style.display = 'none';
    document.getElementById('storyOverlay').style.display = 'flex';
    // autoplay audio if possible
    try { const a = document.getElementById('storyAudio'); a.currentTime = 0; a.play().catch(()=>{}); } catch(e){}
    // when audio ends, after 3s go to super quiz
    const a = document.getElementById('storyAudio');
    if(a){
      a.onended = function(){
        setTimeout(()=>{
          document.getElementById('storyOverlay').style.display = 'none';
          showSuperQuiz();
        }, 3000);
      };
    }
  }
  if(e.target && e.target.id === 'skipStoryBtn'){
    document.getElementById('confirmStoryOverlay').style.display = 'none';
    showSuperQuiz();
  }
  if(e.target && e.target.id === 'storyOkBtn'){
    // user clicked "ƒê√£ nghe xong" button -> wait 3s then show super quiz
    try { document.getElementById('storyAudio').pause(); } catch(e){}
    document.getElementById('storyOverlay').style.display = 'none';
    setTimeout(()=> showSuperQuiz(), 3000);
  }
  if(e.target && e.target.id === 'storySkipBtn'){
    document.getElementById('storyOverlay').style.display = 'none';
    showSuperQuiz();
  }
});

// Override activity3 checkAnswer to intercept Q4 (index 3) correct answer
if(typeof window.checkAnswer === 'function'){
  const orig = window.checkAnswer.bind(window);
  window.checkAnswer = function(selected){
    try {
      // current and quizData are globals in original script
      if(typeof current !== 'undefined' && typeof quizData !== 'undefined'){
        // If this is the 4th question (index 3) and answer is correct -> show poster congrats flow
        if(current === 3 && selected === quizData[current].answer){
          // play correct sound
          try { document.getElementById('correctSound').currentTime = 0; document.getElementById('correctSound').play(); } catch(e){}
          // Show poster congrats overlay instead of normal flow
          showPosterCongrats();
          // increment current to mark question answered (so resume state consistent)
          current++;
          return;
        }
      }
    } catch(e){ console.error(e); }
    // fallback to original behavior
    return orig(selected);
  };
} else {
  // if checkAnswer not found, create a safe stub (unlikely)
  window.checkAnswer = function(selected){
    console.warn('checkAnswer not found - interaction fallback');
  };
}

function showTop50(){
 document.getElementById("leaderboard").style.display="block";
 if(window.loadLeaderboard) loadLeaderboard();
}

function computeScore(correct, time){
 return correct*100 - time;
}


function computeScore(){
    const totalQuestions = 22;
    const base = totalQuestions * 100;
    const timePenalty = Math.floor((Date.now() - window.startTime)/1000);
    const wrongPenalty = window.wrongCount * 100;
    let score = base - timePenalty - wrongPenalty;
    if(score<0) score=0;
    return {score, timePenalty};
}

</script>
<!-- END: Poster congrats + story + super-quiz -->


<script>
// === Story Highlight Sync ===
const storyTimings = [
  {start:0, end:13.5},
  {start:13.5, end:32.8},
  {start:32.8, end:70},
  {start:70, end:105},
  {start:105, end:142},
  {start:142, end:151}
];

const storyAudio = document.getElementById('storyAudio');
const storyParas = Array.from(document.querySelectorAll('#storyText p'));

function updateHighlight(){
  const t = storyAudio.currentTime;
  storyParas.forEach((p,i)=>{
    const seg = storyTimings[i];
    if(seg && t>=seg.start && t<seg.end){
      p.style.background = 'rgba(255,255,0,0.3)';
      p.style.transition = '0.3s';
    } else {
      p.style.background = 'transparent';
    }
  });
}

storyAudio.addEventListener('timeupdate', updateHighlight);

// Popup animations
document.querySelectorAll('#posterCongrats,#confirmStory,#storyBox,#superQuizBox').forEach(el=>{
  el.style.transform='scale(0.85)';
  el.style.opacity='0';
  el.style.transition='all 0.35s ease';
  const obs=new MutationObserver(()=>{
    if(getComputedStyle(el.parentElement).display!=='none'){
      requestAnimationFrame(()=>{
        el.style.transform='scale(1)';
        el.style.opacity='1';
      });
    }
  });
  obs.observe(el.parentElement,{attributes:true,attributeFilter:['style']});
});

// Darker overlays
document.querySelectorAll('#posterCongratsOverlay,#confirmStoryOverlay,#storyOverlay,#superQuizPopup,#superQuizEnd')
  .forEach(el=>el.style.background='rgba(0,0,0,0.75)');

function showTop50(){
 document.getElementById("leaderboard").style.display="block";
 if(window.loadLeaderboard) loadLeaderboard();
}

function computeScore(correct, time){
 return correct*100 - time;
}


function computeScore(){
    const totalQuestions = 22;
    const base = totalQuestions * 100;
    const timePenalty = Math.floor((Date.now() - window.startTime)/1000);
    const wrongPenalty = window.wrongCount * 100;
    let score = base - timePenalty - wrongPenalty;
    if(score<0) score=0;
    return {score, timePenalty};
}

</script>


<script>
// -- Ensure story audio uses relative path so it loads when opening file locally --
(function(){
  const audioEl = document.querySelector('#storyAudio source');
  if(audioEl && audioEl.getAttribute('src').startsWith('/mnt/data/')) {
    audioEl.setAttribute('src', 'voice1.mp3');
    // reload parent audio element if present
    const parent = document.getElementById('storyAudio');
    if(parent){ parent.load(); }
  }
})();

// -- Hide poster when overlays show, restore when all overlays hidden --
(function(){
  const posterEl = document.getElementById('poster');
  const overlays = [
    document.getElementById('posterCongratsOverlay'),
    document.getElementById('confirmStoryOverlay'),
    document.getElementById('storyOverlay'),
    document.getElementById('superQuizPopup'),
    document.getElementById('superQuizEnd')
  ].filter(Boolean);

  function anyOverlayVisible(){
    return overlays.some(o => o && getComputedStyle(o).display !== 'none');
  }

  // Observe changes to style/display of each overlay and hide/show poster accordingly
  overlays.forEach(o=>{
    if(!o) return;
    const obs = new MutationObserver(()=>{
      try{
        if(anyOverlayVisible()){
          if(posterEl) posterEl.style.display = 'none';
        } else {
          if(posterEl) posterEl.style.display = 'block';
        }
      }catch(e){}
    });
    obs.observe(o, { attributes: true, attributeFilter: ['style', 'class'] });
  });

  // Also intercept functions that show overlays via code paths (safer)
  const origShowPosterCongrats = window.showPosterCongrats;
  window.showPosterCongrats = function(){
    if(posterEl) posterEl.style.display='none';
    if(typeof origShowPosterCongrats === 'function') origShowPosterCongrats();
  };

  // When story overlay is shown through direct style changes, ensure audio plays
  const storyOverlay = document.getElementById('storyOverlay');
  const storyAudio = document.getElementById('storyAudio');
  if(storyOverlay){
    const obs2 = new MutationObserver(()=>{
      if(getComputedStyle(storyOverlay).display !== 'none'){
        try{
          if(posterEl) posterEl.style.display='none';
          // attempt to play audio
          if(storyAudio){
            storyAudio.currentTime = 0;
            const p = storyAudio.play();
            if(p && typeof p.catch === 'function'){ p.catch(()=>{}); }
          }
        }catch(e){}
      }
    });
    obs2.observe(storyOverlay, { attributes: true, attributeFilter: ['style', 'class'] });
  }

  // Buttons that close story overlay should restore poster when closed (safety)
  ['storyOkBtn','storySkipBtn','pcContinueBtn'].forEach(id=>{
    const btn = document.getElementById(id);
    if(btn){
      btn.addEventListener('click', ()=>{
        setTimeout(()=>{ if(posterEl) posterEl.style.display='block'; }, 250);
      });
    }
  });
})();

function showTop50(){
 document.getElementById("leaderboard").style.display="block";
 if(window.loadLeaderboard) loadLeaderboard();
}

function computeScore(correct, time){
 return correct*100 - time;
}


function computeScore(){
    const totalQuestions = 22;
    const base = totalQuestions * 100;
    const timePenalty = Math.floor((Date.now() - window.startTime)/1000);
    const wrongPenalty = window.wrongCount * 100;
    let score = base - timePenalty - wrongPenalty;
    if(score<0) score=0;
    return {score, timePenalty};
}

</script>


<script>
// --- Auto pause/resume background music when story popup opens/closes ---
(function(){
  const storyOverlay = document.getElementById('storyOverlay');
  const bg = document.getElementById('bgMusic');
  if(!storyOverlay || !bg) return;

  const obs = new MutationObserver(()=>{
    const visible = getComputedStyle(storyOverlay).display !== 'none';
    if(visible){
      try{ bg.pause(); }catch(e){}
    } else {
      try{ bg.play(); }catch(e){}
    }
  });
  obs.observe(storyOverlay, { attributes:true, attributeFilter:['style','class'] });
})();

function showTop50(){
 document.getElementById("leaderboard").style.display="block";
 if(window.loadLeaderboard) loadLeaderboard();
}

function computeScore(correct, time){
 return correct*100 - time;
}


function computeScore(){
    const totalQuestions = 22;
    const base = totalQuestions * 100;
    const timePenalty = Math.floor((Date.now() - window.startTime)/1000);
    const wrongPenalty = window.wrongCount * 100;
    let score = base - timePenalty - wrongPenalty;
    if(score<0) score=0;
    return {score, timePenalty};
}

</script>


<script>
// FIX 1 ‚Äî T·∫Øt ho√†n to√†n poster n·ªÅn khi ƒëang ·ªü Ho·∫°t ƒë·ªông 3
(function(){
    const poster = document.getElementById("poster");

    const hidePosterWhenQuizRunning = () => {
        if (typeof current !== "undefined" && current < 4) {
            poster.style.display = "none";
        }
    };

    setInterval(hidePosterWhenQuizRunning, 300);
})();

// FIX 2 ‚Äî X√≥a hi·ªáu ·ª©ng s·ªçc ƒë·∫±ng sau popup/story
document.body.style.background = "#6bd5ff";
document.body.style.overflow = "hidden";

function showTop50(){
 document.getElementById("leaderboard").style.display="block";
 if(window.loadLeaderboard) loadLeaderboard();
}

function computeScore(correct, time){
 return correct*100 - time;
}


function computeScore(){
    const totalQuestions = 22;
    const base = totalQuestions * 100;
    const timePenalty = Math.floor((Date.now() - window.startTime)/1000);
    const wrongPenalty = window.wrongCount * 100;
    let score = base - timePenalty - wrongPenalty;
    if(score<0) score=0;
    return {score, timePenalty};
}

</script>


<script>
// FIX chu·∫©n: Khi popup story/confirm/superquiz m·ªü ‚Üí ·∫©n poster ·ªü sau
(function(){
    const overlays = [
        "confirmStoryOverlay",
        "storyOverlay",
        "superQuizPopup",
        "superQuizEnd"
    ];

    function hidePosterBehind() {
        const posterImgs = document.querySelectorAll('#posterCongrats img, #poster img');
        const someOverlayOpen = overlays.some(id => {
            const el = document.getElementById(id);
            return el && getComputedStyle(el).display !== "none";
        });

        posterImgs.forEach(img => {
            img.style.visibility = someOverlayOpen ? "hidden" : "visible";
        });
    }

    setInterval(hidePosterBehind, 200);
})();

function showTop50(){
 document.getElementById("leaderboard").style.display="block";
 if(window.loadLeaderboard) loadLeaderboard();
}

function computeScore(correct, time){
 return correct*100 - time;
}


function computeScore(){
    const totalQuestions = 22;
    const base = totalQuestions * 100;
    const timePenalty = Math.floor((Date.now() - window.startTime)/1000);
    const wrongPenalty = window.wrongCount * 100;
    let score = base - timePenalty - wrongPenalty;
    if(score<0) score=0;
    return {score, timePenalty};
}

</script>


<script>
// === FIX 1: T·∫ÆT HO√ÄN TO√ÄN T·ª∞ PH√ÅT NH·∫†C ·ªû ƒêO·∫†N CU·ªêI ===
document.addEventListener("DOMContentLoaded", ()=>{
    const endAudio = document.getElementById("endAudio");
    if(endAudio){
        endAudio.autoplay = false;
        endAudio.pause();
        endAudio.play = ()=>{}; 
    }
});
if(document.getElementById("storyAudio")){
    document.getElementById("storyAudio").onended = null;
}

// === FIX 2: L√†m highlight ch·ªØ v√†ng ch·∫°y m∆∞·ª£t ===
(function(){
    const storyAudio = document.getElementById("storyAudio");
    const paras = Array.from(document.querySelectorAll("#storyText p"));
    const timings = window.storyTimings || [];

    function updateFast(){
        const t = storyAudio.currentTime;
        paras.forEach((p,i)=>{
            const seg = timings[i];
            if(seg && t >= seg.start && t < seg.end){
                p.style.background = "rgba(255,255,0,0.3)";
            } else {
                p.style.background = "transparent";
            }
        });
    }

    if(storyAudio){
        setInterval(updateFast, 80); 
    }
})();

// === FIX 3: Th√™m CH√ÇN cho c√°c T√íA TH√ÅP, kh√¥ng s·ª≠a game ===
(function(){
    const area = document.getElementById("gameArea");
    if(area){
        const towers = document.querySelectorAll(".tower");
        towers.forEach(t=>{
            const base = document.createElement("div");
            base.style.width = "100%";
            base.style.height = "20px";
            base.style.background = "rgba(0,0,0,0.25)";
            base.style.borderRadius = "0 0 12px 12px";
            base.style.marginTop = "8px";
            t.appendChild(base);
        });
    }
})();

function showTop50(){
 document.getElementById("leaderboard").style.display="block";
 if(window.loadLeaderboard) loadLeaderboard();
}

function computeScore(correct, time){
 return correct*100 - time;
}


function computeScore(){
    const totalQuestions = 22;
    const base = totalQuestions * 100;
    const timePenalty = Math.floor((Date.now() - window.startTime)/1000);
    const wrongPenalty = window.wrongCount * 100;
    let score = base - timePenalty - wrongPenalty;
    if(score<0) score=0;
    return {score, timePenalty};
}

</script>


<script>
// Disable yellow highlight in story
(function(){
    const storyAudio = document.getElementById("storyAudio");
    const paras = document.querySelectorAll("#storyText p");
    paras.forEach(p => p.style.background = "transparent");
    if (storyAudio){ storyAudio.ontimeupdate = null; }
    if (window.storyHighlightInterval){ clearInterval(window.storyHighlightInterval); }
    window.updateHighlight = function(){};
})();

function showTop50(){
 document.getElementById("leaderboard").style.display="block";
 if(window.loadLeaderboard) loadLeaderboard();
}

function computeScore(correct, time){
 return correct*100 - time;
}


function computeScore(){
    const totalQuestions = 22;
    const base = totalQuestions * 100;
    const timePenalty = Math.floor((Date.now() - window.startTime)/1000);
    const wrongPenalty = window.wrongCount * 100;
    let score = base - timePenalty - wrongPenalty;
    if(score<0) score=0;
    return {score, timePenalty};
}

</script>


<style>
body {
    background-attachment: fixed !important;
    background-position: center bottom !important;
}
</style>





<script>
// Fully disable highlight
window.updateHighlight = function(){};
document.querySelectorAll("#storyText p").forEach(p=> p.style.background = "transparent");
if (window.storyHighlightInterval) clearInterval(window.storyHighlightInterval);

function showTop50(){
 document.getElementById("leaderboard").style.display="block";
 if(window.loadLeaderboard) loadLeaderboard();
}

function computeScore(correct, time){
 return correct*100 - time;
}


function computeScore(){
    const totalQuestions = 22;
    const base = totalQuestions * 100;
    const timePenalty = Math.floor((Date.now() - window.startTime)/1000);
    const wrongPenalty = window.wrongCount * 100;
    let score = base - timePenalty - wrongPenalty;
    if(score<0) score=0;
    return {score, timePenalty};
}

</script>


<script>
// Stop story audio when skipping
document.addEventListener("DOMContentLoaded", ()=>{
  const a=document.getElementById("storyAudio");
  const ids=["skipStoryBtn","storySkipBtn"];
  ids.forEach(id=>{
    const b=document.getElementById(id);
    if(b){
      b.addEventListener("click", ()=>{
        if(a){ a.pause(); a.currentTime=0; }
      });
    }
  });
});

function showTop50(){
 document.getElementById("leaderboard").style.display="block";
 if(window.loadLeaderboard) loadLeaderboard();
}

function computeScore(correct, time){
 return correct*100 - time;
}


function computeScore(){
    const totalQuestions = 22;
    const base = totalQuestions * 100;
    const timePenalty = Math.floor((Date.now() - window.startTime)/1000);
    const wrongPenalty = window.wrongCount * 100;
    let score = base - timePenalty - wrongPenalty;
    if(score<0) score=0;
    return {score, timePenalty};
}

</script>


<style>
#storyText p {
    background: transparent !important;
}
</style>

<script>
// Hard-disable highlight
window.updateHighlight = function(){};
if (window.storyHighlightInterval) clearInterval(window.storyHighlightInterval);

// Remove any background color that may be applied later
document.addEventListener("DOMContentLoaded", ()=>{
    document.querySelectorAll("#storyText p").forEach(p=>{
        p.style.background = "transparent";
    });
});

function showTop50(){
 document.getElementById("leaderboard").style.display="block";
 if(window.loadLeaderboard) loadLeaderboard();
}

function computeScore(correct, time){
 return correct*100 - time;
}


function computeScore(){
    const totalQuestions = 22;
    const base = totalQuestions * 100;
    const timePenalty = Math.floor((Date.now() - window.startTime)/1000);
    const wrongPenalty = window.wrongCount * 100;
    let score = base - timePenalty - wrongPenalty;
    if(score<0) score=0;
    return {score, timePenalty};
}

</script>


<!-- FIREBASE LEADERBOARD -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js";
  import { getFirestore, collection, addDoc, getDocs, query, orderBy, limit } 
    from "https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyBp-d-t6eQGvXTehgoPD-h9x8B1yUg2Lc",
    authDomain: "an-toan-internet.firebaseapp.com",
    projectId: "an-toan-internet",
    storageBucket: "an-toan-internet.appspot.com",
    messagingSenderId: "32947390909",
    appId: "1:32947390909:web:71ec5d85e0b0cef78d4a5f",
    measurementId: "G-X7HLNTRBZG"
};

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  window.saveResult = async function(name, cls, school, correct, time){
    await addDoc(collection(db, "leaderboard"), {
      name, cls, school, correct, time,
      created: Date.now()
    });
  };

  window.loadLeaderboard = async function(){
    const q = query(
      collection(db, "leaderboard"),
      orderBy("correct", "desc"),
      orderBy("time", "asc"),
      limit(50)
    );
    const snap = await getDocs(q);
    let html = "";
    snap.forEach(doc=>{
      const d = doc.data();
      
let medal = "";
if (html === "") medal = "ü•á";
else if (!html.includes("ü•á")) medal = "ü•á";
else if (!html.includes("ü•à")) medal = "ü•à";
else if (!html.includes("ü•â")) medal = "ü•â";

html += `<tr>
  <td class='medal'>${medal}</td>

        <td>${d.name}</td>
        <td>${d.cls}</td>
        <td>${d.school}</td>
        <td>${d.correct}</td>
        <td>${d.time}s</td>
      </tr>`;
    });
    const body = document.getElementById("leaderboardBody");
    if(body) body.innerHTML = html;
  };

  window.loadMyRank = async function(){
    const q = query(
      collection(db, "leaderboard"),
      where("name", "==", window.playerInfo.name),
      where("cls", "==", window.playerInfo.cls),
      where("school", "==", window.playerInfo.school),
      orderBy("created", "desc"),
      limit(1)
    );

    const snap = await getDocs(q);
    let htmlRow = "";
    snap.forEach(doc => {
      const d = doc.data();
      htmlRow += `
        <tr>
          <td>üèÖ</td>
          <td>${d.name}</td>
          <td>${d.cls}</td>
          <td>${d.school}</td>
          <td>${d.correct}</td>
          <td>${d.time}s</td>
        </tr>
      `;
    });

    document.getElementById("leaderboardBody").innerHTML = htmlRow;
    document.getElementById("leaderboard").style.display = "block";
  };


function showTop50(){
 document.getElementById("leaderboard").style.display="block";
 if(window.loadLeaderboard) loadLeaderboard();
}

function computeScore(correct, time){
 return correct*100 - time;
}


function computeScore(){
    const totalQuestions = 22;
    const base = totalQuestions * 100;
    const timePenalty = Math.floor((Date.now() - window.startTime)/1000);
    const wrongPenalty = window.wrongCount * 100;
    let score = base - timePenalty - wrongPenalty;
    if(score<0) score=0;
    return {score, timePenalty};
}

</script>
<!-- LEADERBOARD TABLE -->
<div id="leaderboard" style="display:none" style="margin-top:30px;">
  <h2>B·∫£ng x·∫øp h·∫°ng TOP 50</h2>
  <table border="1" width="100%">
    <thead>
      <tr>
        <th>H·∫°ng</th><th>T√™n</th>
        <th>L·ªõp</th>
        <th>Tr∆∞·ªùng</th>
        <th>ƒêi·ªÉm</th>
        <th>Th·ªùi gian</th>
      </tr>
    </thead>
    <tbody id="leaderboardBody"></tbody>
  </table>
</div>


<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js";
  import { 
    getFirestore, collection, addDoc, getDocs, query, where, orderBy, limit 
  } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyBp-d-t6eQGvXTehgoPD-h9x8B1yUg2Lc",
    authDomain: "an-toan-internet.firebaseapp.com",
    projectId: "an-toan-internet",
    storageBucket: "an-toan-internet.appspot.com",
    messagingSenderId: "32947390909",
    appId: "1:32947390909:web:71ec5d85e0b0cef78d4a5f",
    measurementId: "G-X7HLNTRBZG"
};

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  window.saveResult = async function(player){
    await addDoc(collection(db,"leaderboard"), player);
  };

  window.loadLeaderboard = async function(){
    const q = query(collection(db,"leaderboard"),
      orderBy("correct","desc"),
      orderBy("time","asc"),
      limit(50)
    );
    const snap = await getDocs(q);
    let rows="";
    snap.forEach(d=>{
      const x=d.data();
      rows += `<tr><td>${x.name}</td><td>${x.class}</td><td>${x.school}</td><td>${x.correct}</td><td>${x.time}</td></tr>`;
    });
    const body=document.getElementById("leaderboardBody");
    if(body) body.innerHTML=rows;
  };

function computeScore(){
    const totalQuestions = 22;
    const base = totalQuestions * 100;
    const timePenalty = Math.floor((Date.now() - window.startTime)/1000);
    const wrongPenalty = window.wrongCount * 100;
    let score = base - timePenalty - wrongPenalty;
    if(score<0) score=0;
    return {score, timePenalty};
}

</script>


<!-- Leaderboard Section -->
<div id="leaderboardBox" style="display:none; position:fixed; top:50%; left:50%; transform:translate(-50%,-50%);
background:white; padding:20px; border-radius:12px; width:90%; max-width:400px; box-shadow:0 0 20px rgba(0,0,0,0.3); z-index:99999;">
  <h3 style="margin-top:0; text-align:center;">üèÜ TOP 50</h3>
  <table style="width:100%; border-collapse:collapse; font-size:14px;">
    <thead>
      <tr>
        <th>T√™n</th><th>L·ªõp</th><th>Tr∆∞·ªùng</th><th>ƒê√∫ng</th><th>Th·ªùi gian</th>
      </tr>
    </thead>
    <tbody id="leaderboardBody"></tbody>
  </table>
  <button onclick="document.getElementById('leaderboardBox').style.display='none'"
    style="margin-top:15px; width:100%; padding:8px; border:none; border-radius:8px; background:#007bff; color:white;">
    ƒê√≥ng
  </button>
</div>

<button id="openLeaderboardBtn"
 onclick="document.getElementById('leaderboardBox').style.display='block'; loadLeaderboard();"
 style="position:fixed; bottom:20px; right:20px; padding:10px 14px; background:#ff9800; color:#fff; border:none; border-radius:50%; font-size:14px; z-index:9999;">
 üèÜ
</button>


<script>
(function(){
  const target = document.getElementById('outroScreen');
  if(!target) return;
  const obs = new MutationObserver(()=>{
    const st = window.getComputedStyle(target).display;
    if(st !== 'none'){
      try{
        window.endTime = Date.now();
        window.totalTime = Math.floor((window.endTime - window.startTime)/1000);
        if(window.correctAnswers!==undefined){
          window.playerScore = window.correctAnswers - window.totalTime;
        }
        if(window.submitScoreIfBetter) window.submitScoreIfBetter();
      }catch(e){ console.error(e); }
    }
  });
  obs.observe(target, { attributes:true, attributeFilter:['style'] });
})();

function computeScore(){
    const totalQuestions = 22;
    const base = totalQuestions * 100;
    const timePenalty = Math.floor((Date.now() - window.startTime)/1000);
    const wrongPenalty = window.wrongCount * 100;
    let score = base - timePenalty - wrongPenalty;
    if(score<0) score=0;
    return {score, timePenalty};
}

</script>


<div id="scorePopup" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.65); 
    z-index:99999; justify-content:center; align-items:center;">
  <div style="background:white; padding:25px; border-radius:14px; width:320px; text-align:center;
    box-shadow:0 8px 25px rgba(0,0,0,0.35); font-family:Arial;">
      <h2>üéâ ƒêi·ªÉm c·ªßa b·∫°n</h2>
      <p id="scorePopupText" style="font-size:18px; margin-top:10px;"></p>
      <button onclick="document.getElementById('scorePopup').style.display='none';"
        style="margin-top:15px; padding:10px 20px; border:none; background:#00a8ff; color:white;
        border-radius:8px; cursor:pointer;">ƒê√≥ng</button>
  </div>
</div>


<script>
(function(){
  
function showScorePopup(){
    const result = computeScore();
    const score = result.score;
    const time = result.timePenalty;
    const correct = window.correctCount || 0;
    const wrong = window.wrongCount || 0;

    const html = `
        <strong>ƒêi·ªÉm t·ªïng: ${score}</strong><br>
        ‚è± Th·ªùi gian: ${time} gi√¢y<br>
        ‚úî ƒê√∫ng: ${correct} / 22<br>
        ‚ùå Sai: ${wrong} c√¢u
    `;
    document.getElementById('scorePopupText').innerHTML = html;
    document.getElementById('scorePopup').style.display = 'flex';
}
 c√¢u trong ${time} gi√¢y.<br><b>ƒêi·ªÉm: ${score}</b>`;
      document.getElementById('scorePopupText').innerHTML = txt;
      document.getElementById('scorePopup').style.display='flex';
    }catch(e){ console.error(e); }
  }

  const target = document.getElementById('outroScreen');
  if(!target) return;

  const obs2 = new MutationObserver(()=>{
    const st = window.getComputedStyle(target).display;
    if(st !== 'none'){
      setTimeout(showScorePopup, 800);
    }
  });
  obs2.observe(target, { attributes:true, attributeFilter:['style'] });
})();

function computeScore(){
    const totalQuestions = 22;
    const base = totalQuestions * 100;
    const timePenalty = Math.floor((Date.now() - window.startTime)/1000);
    const wrongPenalty = window.wrongCount * 100;
    let score = base - timePenalty - wrongPenalty;
    if(score<0) score=0;
    return {score, timePenalty};
}

</script>


<script>
// global correctAnswers
window.correctAnswers = 0;

// delegate for any button or div with correct:true in dataset or JS object
document.addEventListener('click', function(e){
    const el = e.target.closest('[data-correct]');
    if(el){
        if(el.dataset.correct === "true"){
            window.correctAnswers++;
        }
    }
});

function computeScore(){
    const totalQuestions = 22;
    const base = totalQuestions * 100;
    const timePenalty = Math.floor((Date.now() - window.startTime)/1000);
    const wrongPenalty = window.wrongCount * 100;
    let score = base - timePenalty - wrongPenalty;
    if(score<0) score=0;
    return {score, timePenalty};
}

</script>

</body>
</html>
